<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>تقديم طلب للمواطنين</title>
<style>
* {
margin: 0;
padding: 0;
box-sizing: border-box;
font-family: 'Tajawal', 'Segoe UI', Tahoma, sans-serif;
}
body {
background: linear-gradient(135deg, #f0f4f8 0%, #e2eaf5 100%);
min-height: 100vh;
display: flex;
justify-content: center;
align-items: center;
padding: 20px;
}
.card {
background: white;
border-radius: 16px;
box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
width: 100%;
max-width: 550px;
padding: 30px;
}
.header {
text-align: center;
margin-bottom: 25px;
}
.header h1 {
color: #1a3a6c;
font-size: 24px;
font-weight: 700;
}
.form-group {
margin-bottom: 18px;
}
label {
display: block;
margin-bottom: 6px;
font-weight: 600;
color: #333;
}
input, select, textarea {
width: 100%;
padding: 12px;
border: 1px solid #ccc;
border-radius: 8px;
font-size: 16px;
direction: rtl;
}
input[type="email"], input[type="tel"] {
direction: ltr;
text-align: left;
}
input[type="date"] {
direction: ltr;
text-align: left;
}
textarea {
min-height: 100px;
resize: vertical;
}
button {
width: 100%;
padding: 14px;
background: #1a73e8;
color: white;
border: none;
border-radius: 8px;
font-size: 18px;
font-weight: 600;
cursor: pointer;
transition: background 0.3s;
}
button:hover {
background: #0d5bb8;
}
button:disabled {
background: #b0c4de;
cursor: not-allowed;
}
#status {
margin-top: 20px;
text-align: center;
min-height: 24px;
font-weight: 600;
}
.success { color: #2e7d32; }
.error { color: #d32f2f; }
@media (max-width: 480px) {
.card { padding: 20px; }
.header h1 { font-size: 20px; }
}
</style>
</head>
<body>
<div class="card">
<div class="header">
<h1>أرسل طلبك كمواطن</h1>
</div>
<form id="citizenForm">
<div class="form-group">
<label for="national_id">رقم الهوية الوطنية <span class="text-danger">*</span></label>
<input type="text" id="national_id" required placeholder="مثال: 295012345678" maxlength="12" />
</div>
<div class="form-group">
<label for="applicant_name">اسم مقدم الطلب <span class="text-danger">*</span></label>
<input type="text" id="applicant_name" required placeholder="الاسم الكامل كما في الهوية" />
</div>
<div class="form-group">
<label for="email">البريد الإلكتروني (اختياري)</label>
<input type="email" id="email" placeholder="example@email.com" />
</div>
<div class="form-group">
<label for="phone">رقم الهاتف (اختياري)</label>
<input type="tel" id="phone" placeholder="010XXXXXXXX" />
</div>
<div class="form-group">
<label for="request_title">عنوان الطلب <span class="text-danger">*</span></label>
<input type="text" id="request_title" required placeholder="مثال: صيانة إنارة الشارع" />
</div>
<div class="form-group">
<label for="request_date">تاريخ تقديم الطلب <span class="text-danger">*</span></label>
<input type="date" id="request_date" required />
</div>
<div class="form-group">
<label for="category">الفئة <span class="text-danger">*</span></label>
<select id="category" required>
<option value="">اختر الفئة</option>
<option value="خدمات عامة">خدمات عامة</option>
<option value="صحة">صحة</option>
<option value="كهرباء">كهرباء</option>
<option value="صرف صحى">صرف صحى</option>
<option value="مواصلات">مواصلات</option>
<option value="سياحة">سياحة</option>
<option value="الصناعة">الصناعة</option>
<option value="التموين">التموين</option>
<option value="الزراعه">الزراعه</option>
<option value="العدل">العدل</option>
<option value="تعليم">تعليم</option>
<option value="بنية تحتية">بنية تحتية</option>
<option value="الداخلية">الداخلية</option>
<option value="أخرى">أخرى</option>
</select>
</div>
<div class="form-group">
<label for="request_summary">تفاصيل الطلب <span class="text-danger">*</span></label>
<textarea id="request_summary" required placeholder="اشرح طلبك بوضوح..."></textarea>
</div>
<div class="form-group">
<label for="attachment">مرفق (اختياري: صورة أو PDF)</label>
<input type="file" id="attachment" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" />
</div>
<button type="submit" id="submitBtn">إرسال الطلب</button>
</form>
<div id="status"></div>
</div>

<!-- Supabase SDK -->
<script type="module">
const SUPABASE_URL = 'https://gcgjzqiumgesultletws.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjZ2p6cWl1bWdlc3VsdGxldHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0Njg1MTksImV4cCI6MjA4NDA0NDUxOX0.ZGQMe3J22-pdlB_zU_jKofk-tR56kWY7TK5JfDB_fJo';

import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// تعيين تاريخ اليوم افتراضيًا
document.getElementById('request_date').valueAsDate = new Date();

document.getElementById('citizenForm').addEventListener('submit', async (e) => {
e.preventDefault();
const submitBtn = document.getElementById('submitBtn');
submitBtn.disabled = true;
document.getElementById('status').innerHTML = '';

const national_id = document.getElementById('national_id').value.trim();
const applicant_name = document.getElementById('applicant_name').value.trim();
const email = document.getElementById('email').value.trim();
const phone = document.getElementById('phone').value.trim();
const request_title = document.getElementById('request_title').value.trim();
const request_date = document.getElementById('request_date').value;
const category = document.getElementById('category').value;
const request_summary = document.getElementById('request_summary').value.trim();

if (!national_id || !applicant_name || !request_title || !request_date || !category || !request_summary) {
showStatus('يرجى ملء جميع الحقول المطلوبة.', 'error');
submitBtn.disabled = false;
return;
}

let attachment_url = null;

try {
// رفع المرفق إذا وُجد
const fileInput = document.getElementById('attachment');
if (fileInput.files && fileInput.files[0]) {
const file = fileInput.files[0];

// التحقق من الحجم (5 ميغابايت كحد أقصى)
if (file.size > 5 * 1024 * 1024) {
throw new Error('حجم الملف كبير جدًّا. الحد الأقصى هو 5 ميغابايت.');
}

// التحقق من النوع
const allowedTypes = [
'image/jpeg',
'image/png',
'application/pdf',
'application/msword',
'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
];
if (!allowedTypes.includes(file.type)) {
throw new Error('نوع الملف غير مدعوم. يُرجى رفع صورة، PDF، أو مستند Word.');
}

const ext = file.name.split('.').pop().toLowerCase();
const fileName = `${Date.now()}_${Math.random().toString(36).substring(2)}.${ext}`;
const filePath = `requests/${fileName}`;

const { error: uploadError } = await supabase.storage
.from('requests')
.upload(filePath, file, { upsert: false });

if (uploadError) throw uploadError;

const { data } = supabase.storage.from('requests').getPublicUrl(filePath);
attachment_url = data.publicUrl;
}

// إرسال الطلب إلى قاعدة البيانات
const { error } = await supabase
.from('citizen_requests')
.insert([{
national_id,
applicant_name,
email: email || null,
phone: phone || null,
request_title,
request_summary,
request_date,
category,
attachment_url // قد يكون null
}]);

if (error) throw error;

showStatus('✅ تم إرسال طلبك بنجاح! سيتم مراجعته قريبًا.', 'success');
document.getElementById('citizenForm').reset();
document.getElementById('request_date').valueAsDate = new Date();
} catch (err) {
console.error('Error:', err.message || err);
showStatus(`❌ ${err.message || 'حدث خطأ أثناء الإرسال. حاول مرة أخرى.'}`, 'error');
} finally {
submitBtn.disabled = false;
}
});

function showStatus(msg, type) {
document.getElementById('status').innerHTML = `<p class="${type}">${msg}</p>`;
}
</script>
</body>
</html>