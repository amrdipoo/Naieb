<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>نظام متابعة طلبات المواطنين - عضو مجلس النواب</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    :root {
      --primary-color: #1e3a8a;
      --secondary-color: #3b82f6;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --light-bg: #f8fafc;
      --dark-text: #1e293b;
      --card-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--light-bg);
      color: var(--dark-text);
      direction: rtl;
    }
    .navbar-brand {
      font-weight: bold;
      color: white !important;
    }
    .btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .btn-success { background-color: var(--success-color); border-color: var(--success-color); }
    .btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); }
    .btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
    .card { box-shadow: var(--card-shadow); border: none; margin-bottom: 1.5rem; }
    .category-electricity { border-right: 4px solid #f97316; }
    .category-health { border-right: 4px solid #ef4444; }
    .category-education { border-right: 4px solid #3b82f6; }
    .category-housing { border-right: 4px solid #8b5cf6; }
    .category-employment { border-right: 4px solid #10b981; }
    .category-other { border-right: 4px solid #6b7280; }
    .priority-high { color: var(--danger-color); font-weight: bold; }
    .priority-medium { color: var(--warning-color); }
    .priority-low { color: var(--success-color); }
    .status-submitted { color: #64748b; }
    .status-in-progress { color: var(--warning-color); }
    .status-resolved { color: var(--success-color); }
    .status-rejected { color: var(--danger-color); }
    .welcome-section { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 4rem 0; text-align: center; }
    .feature-card { transition: transform 0.3s ease; }
    .feature-card:hover { transform: translateY(-5px); }
    .toast { direction: rtl; }
    .sidebar { height: 100vh; position: fixed; overflow-y: auto; }
    .main-content { margin-right: 250px; padding: 20px; }
    @media (max-width: 992px) {
      .sidebar { width: 100%; height: auto; position: relative; }
      .main-content { margin-right: 0; }
    }
  </style>
</head>
<body>

<!-- شاشة البداية -->
<div id="welcomeScreen" class="welcome-section">
  <div class="container">
    <h1 class="display-4 fw-bold mb-4">نظام متابعة طلبات المواطنين</h1>
    <p class="lead mb-5">مرحباً بك في النظام الإلكتروني لمتابعة طلبات المواطنين الخاص بعضو مجلس النواب</p>
    <div class="row justify-content-center">
      <div class="col-md-4 mb-4">
        <div class="card feature-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-file-alt fa-2x mb-3 text-primary"></i>
            <h5>تقديم الطلبات</h5>
            <p>قدم طلبك بسهولة وتابع حالته في أي وقت</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card feature-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-chart-bar fa-2x mb-3 text-success"></i>
            <h5>تقارير وإحصائيات</h5>
            <p>احصل على تقارير مفصلة عن الطلبات حسب الفئات</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card feature-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-user-shield fa-2x mb-3 text-warning"></i>
            <h5>إدارة آمنة</h5>
            <p>نظام إدارة متكامل للموظفين والمشرفين</p>
          </div>
        </div>
      </div>
    </div>
    <button class="btn btn-light btn-lg me-3" onclick="showPage('loginPage')">
      <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
    </button>
    <button class="btn btn-outline-light btn-lg" onclick="showPage('registerPage')">
      <i class="fas fa-user-plus me-2"></i>إنشاء حساب
    </button>
  </div>
</div>

<!-- صفحة تسجيل الدخول -->
<div id="loginPage" class="page" style="display:none;">
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center bg-primary text-white">
            <h4><i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول</h4>
          </div>
          <div class="card-body">
            <div id="loginAlert" class="alert alert-danger d-none"></div>
            <div class="mb-3">
              <label for="username" class="form-label">البريد الإلكتروني</label>
              <input type="text" class="form-control" id="username" placeholder="أدخل بريدك الإلكتروني">
            </div>
            <div class="mb-3">
              <label for="password" class="form-label">كلمة المرور</label>
              <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور">
            </div>
            <button class="btn btn-primary w-100" onclick="loginUser()">
              <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
            </button>
            <div class="text-center mt-3">
              <small>ليس لديك حساب؟ <a href="#" onclick="showPage('registerPage')">أنشئ حساباً</a></small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- صفحة التسجيل -->
<div id="registerPage" class="page" style="display:none;">
  <div class="container mt-5">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center bg-success text-white">
            <h4><i class="fas fa-user-plus me-2"></i>إنشاء حساب جديد</h4>
          </div>
          <div class="card-body">
            <div id="registerAlert" class="alert alert-danger d-none"></div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="fullName" class="form-label">الاسم الكامل</label>
                <input type="text" class="form-control" id="fullName" placeholder="الاسم الكامل">
              </div>
              <div class="col-md-6 mb-3">
                <label for="regUsername" class="form-label">اسم المستخدم</label>
                <input type="text" class="form-control" id="regUsername" placeholder="اسم المستخدم">
              </div>
            </div>
            <div class="mb-3">
              <label for="email" class="form-label">البريد الإلكتروني</label>
              <input type="email" class="form-control" id="email" placeholder="example@email.com">
            </div>
            <div class="mb-3">
              <label for="phone" class="form-label">رقم الهاتف</label>
              <input type="text" class="form-control" id="phone" placeholder="01XXXXXXXXX">
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="regPassword" class="form-label">كلمة المرور</label>
                <input type="password" class="form-control" id="regPassword" placeholder="كلمة المرور">
              </div>
              <div class="col-md-6 mb-3">
                <label for="confirmPassword" class="form-label">تأكيد كلمة المرور</label>
                <input type="password" class="form-control" id="confirmPassword" placeholder="تأكيد كلمة المرور">
              </div>
            </div>
            <div class="mb-3">
              <label for="role" class="form-label">الصلاحية</label>
              <select class="form-select" id="role">
                <option value="citizen">مواطن</option>
                <option value="employee">موظف</option>
                <option value="admin">مدير النظام</option>
              </select>
            </div>
            <div class="mb-3 form-check">
              <input type="checkbox" class="form-check-input" id="agreeTerms">
              <label class="form-check-label" for="agreeTerms">أوافق على الشروط والأحكام</label>
            </div>
            <button class="btn btn-success w-100" onclick="registerUser()">
              <i class="fas fa-user-plus me-2"></i>إنشاء الحساب
            </button>
            <div class="text-center mt-3">
              <small>لديك حساب؟ <a href="#" onclick="showPage('loginPage')">سجل الدخول</a></small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- المحتوى الرئيسي بعد تسجيل الدخول -->
<div id="appContent" style="display:none;">
  <!-- التنقل العلوي -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">
        <i class="fas fa-landmark me-2"></i>نظام متابعة طلبات المواطنين
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
              <i class="fas fa-user me-1"></i>مرحباً، <span id="currentUserFullName">...</span>
            </a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" onclick="showPage('profilePage')"><i class="fas fa-user me-2"></i>ملفي الشخصي</a></li>
              <li><a class="dropdown-item" href="#" onclick="showPage('settingsPage')"><i class="fas fa-cog me-2"></i>الإعدادات</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج</a></li>
            </ul>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container-fluid mt-4">
    <div class="row">
      <!-- الشريط الجانبي -->
      <div class="col-md-3 col-lg-2 sidebar bg-light p-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showPage('dashboard')">
              <i class="fas fa-tachometer-alt me-2"></i>لوحة التحكم
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showPage('requestsPage')">
              <i class="fas fa-file-alt me-2"></i>جميع الطلبات
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showPage('newRequestPage')">
              <i class="fas fa-plus-circle me-2"></i>طلب جديد
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showPage('searchPage')">
              <i class="fas fa-search me-2"></i>بحث متقدم
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showPage('categoriesPage')">
              <i class="fas fa-th-large me-2"></i>الفئات
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="#" onclick="showPage('reportsPage')">
              <i class="fas fa-chart-bar me-2"></i>التقارير
            </a>
          </li>
          <li class="nav-item" id="adminMenu" style="display:none;">
            <a class="nav-link" href="#" onclick="showPage('usersPage')">
              <i class="fas fa-users me-2"></i>إدارة المستخدمين
            </a>
          </li>
          <li class="nav-item" id="adminMenu2" style="display:none;">
            <a class="nav-link" href="#" onclick="showPage('activitiesPage')">
              <i class="fas fa-history me-2"></i>سجل الأنشطة
            </a>
          </li>
        </ul>
      </div>

      <!-- المحتوى الرئيسي -->
      <div class="col-md-9 col-lg-10 main-content">
        <!-- لوحة التحكم -->
        <div id="dashboard" class="page">
          <h2 class="mb-4"><i class="fas fa-tachometer-alt me-2"></i>لوحة التحكم</h2>
          <div class="row">
            <div class="col-md-3 mb-4">
              <div class="card text-white bg-primary">
                <div class="card-body">
                  <h5 class="card-title"><i class="fas fa-file-alt me-2"></i>إجمالي الطلبات</h5>
                  <h2 id="totalRequestsCount" class="display-6">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-4">
              <div class="card text-white bg-warning">
                <div class="card-body">
                  <h5 class="card-title"><i class="fas fa-clock me-2"></i>قيد المراجعة</h5>
                  <h2 id="pendingRequestsCount" class="display-6">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-4">
              <div class="card text-white bg-success">
                <div class="card-body">
                  <h5 class="card-title"><i class="fas fa-check-circle me-2"></i>تم الحل</h5>
                  <h2 id="resolvedRequestsCount" class="display-6">0</h2>
                </div>
              </div>
            </div>
            <div class="col-md-3 mb-4">
              <div class="card text-white bg-danger">
                <div class="card-body">
                  <h5 class="card-title"><i class="fas fa-times-circle me-2"></i>مرفوضة</h5>
                  <h2 id="rejectedRequestsCount" class="display-6">0</h2>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-8 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>توزيع الطلبات حسب الفئة</h5>
                </div>
                <div class="card-body">
                  <canvas id="categoryChart" height="200"></canvas>
                </div>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>الطلبات العاجلة</h5>
                </div>
                <div class="card-body">
                  <div id="urgentRequestsList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- جميع الطلبات -->
        <div id="requestsPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-file-alt me-2"></i>جميع الطلبات</h2>
          <div class="mb-3">
            <input type="text" class="form-control" id="requestsSearch" placeholder="ابحث في الطلبات...">
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>الرقم القومي</th>
                  <th>اسم مقدم الطلب</th>
                  <th>عنوان الطلب</th>
                  <th>الفئة</th>
                  <th>الأولوية</th>
                  <th>الحالة</th>
                  <th>تاريخ الإنشاء</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody id="requestsTableBody">
                <!-- سيتم ملؤه ديناميكياً -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- طلب جديد -->
        <div id="newRequestPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-plus-circle me-2"></i>طلب جديد</h2>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newNationalId" class="form-label">الرقم القومي (14 رقم)</label>
                  <input type="text" class="form-control" id="newNationalId" maxlength="14">
                </div>
                <div class="col-md-6 mb-3">
                  <label for="newApplicantName" class="form-label">اسم مقدم الطلب</label>
                  <input type="text" class="form-control" id="newApplicantName">
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="newCategory" class="form-label">الفئة</label>
                  <select class="form-select" id="newCategory">
                    <option value="electricity">كهرباء</option>
                    <option value="health">صحة</option>
                    <option value="education">تعليم</option>
                    <option value="housing">إسكان</option>
                    <option value="employment">توظيف</option>
                    <option value="other">أخرى</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="newPriority" class="form-label">الأولوية</label>
                  <select class="form-select" id="newPriority">
                    <option value="low">منخفضة</option>
                    <option value="medium">متوسطة</option>
                    <option value="high">عالية</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="newRequestTitle" class="form-label">عنوان الطلب</label>
                <input type="text" class="form-control" id="newRequestTitle">
              </div>
              <div class="mb-3">
                <label for="newRequestSummary" class="form-label">ملخص الطلب</label>
                <textarea class="form-control" id="newRequestSummary" rows="4"></textarea>
              </div>
              <button class="btn btn-success" onclick="saveNewRequest()">
                <i class="fas fa-save me-2"></i>حفظ الطلب
              </button>
            </div>
          </div>
        </div>

        <!-- صفحات أخرى (search, categories, reports, etc.) -->
        <div id="searchPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-search me-2"></i>بحث متقدم</h2>
          <div class="card">
            <div class="card-body">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="searchNationalId" class="form-label">الرقم القومي</label>
                  <input type="text" class="form-control" id="searchNationalId">
                </div>
                <div class="col-md-4 mb-3">
                  <label for="searchCategory" class="form-label">الفئة</label>
                  <select class="form-select" id="searchCategory">
                    <option value="">الكل</option>
                    <option value="electricity">كهرباء</option>
                    <option value="health">صحة</option>
                    <option value="education">تعليم</option>
                    <option value="housing">إسكان</option>
                    <option value="employment">توظيف</option>
                    <option value="other">أخرى</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="searchStatus" class="form-label">الحالة</label>
                  <select class="form-select" id="searchStatus">
                    <option value="">الكل</option>
                    <option value="submitted">قيد المراجعة</option>
                    <option value="in-progress">قيد التنفيذ</option>
                    <option value="resolved">تم الحل</option>
                    <option value="rejected">مرفوض</option>
                  </select>
                </div>
              </div>
              <button class="btn btn-primary" onclick="performAdvancedSearch()">
                <i class="fas fa-search me-2"></i>بحث
              </button>
            </div>
          </div>
          <div class="mt-4" id="searchResults"></div>
        </div>

        <div id="categoriesPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-th-large me-2"></i>الفئات</h2>
          <div class="row" id="categoriesGrid">
            <!-- سيتم ملؤه ديناميكياً -->
          </div>
        </div>

        <div id="reportsPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>التقارير</h2>
          <div class="card">
            <div class="card-body">
              <h5>تقرير الطلبات حسب الفترة</h5>
              <div class="row mb-3">
                <div class="col-md-4">
                  <label for="reportStartDate" class="form-label">من تاريخ</label>
                  <input type="date" class="form-control" id="reportStartDate">
                </div>
                <div class="col-md-4">
                  <label for="reportEndDate" class="form-label">إلى تاريخ</label>
                  <input type="date" class="form-control" id="reportEndDate">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                  <button class="btn btn-primary w-100" onclick="generateReport()">
                    <i class="fas fa-file-pdf me-2"></i>توليد التقرير
                  </button>
                </div>
              </div>
              <div id="reportOutput"></div>
            </div>
          </div>
        </div>

        <div id="usersPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-users me-2"></i>إدارة المستخدمين</h2>
          <button class="btn btn-success mb-3" onclick="showNewUserModal()">
            <i class="fas fa-user-plus me-2"></i>إضافة مستخدم جديد
          </button>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead>
                <tr>
                  <th>الاسم</th>
                  <th>اسم المستخدم</th>
                  <th>البريد الإلكتروني</th>
                  <th>الصلاحية</th>
                  <th>الحالة</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody id="usersTableBody">
                <!-- سيتم ملؤه لاحقاً -->
              </tbody>
            </table>
          </div>
        </div>

        <div id="activitiesPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-history me-2"></i>سجل الأنشطة</h2>
          <div id="activitiesList"></div>
        </div>

        <div id="settingsPage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-cog me-2"></i>الإعدادات</h2>
          <div class="card">
            <div class="card-body">
              <h5>إعدادات الحساب</h5>
              <div class="mb-3">
                <label for="settingsFullName" class="form-label">الاسم الكامل</label>
                <input type="text" class="form-control" id="settingsFullName">
              </div>
              <div class="mb-3">
                <label for="settingsEmail" class="form-label">البريد الإلكتروني</label>
                <input type="email" class="form-control" id="settingsEmail">
              </div>
              <div class="mb-3">
                <label for="settingsPhone" class="form-label">رقم الهاتف</label>
                <input type="text" class="form-control" id="settingsPhone">
              </div>
              <button class="btn btn-primary" onclick="saveSettings()">
                <i class="fas fa-save me-2"></i>حفظ التغييرات
              </button>
            </div>
          </div>
        </div>

        <div id="profilePage" class="page" style="display:none;">
          <h2 class="mb-4"><i class="fas fa-user me-2"></i>ملفي الشخصي</h2>
          <div class="card">
            <div class="card-body text-center">
              <img src="https://ui-avatars.com/api/?name=Amro+Abdelrauf&background=1e3a8a&color=fff" class="rounded-circle mb-3" width="120" height="120" alt="Profile">
              <h4 id="profileFullName">...</h4>
              <p id="profileRole" class="text-muted">...</p>
              <div class="mt-4">
                <p><strong>البريد الإلكتروني:</strong> <span id="profileEmail">...</span></p>
                <p><strong>رقم الهاتف:</strong> <span id="profilePhone">...</span></p>
                <p><strong>تاريخ الانضمام:</strong> <span id="profileCreatedAt">...</span></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast للإشعارات -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="notificationToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">إشعار</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage"></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// === Navigation - Pure JavaScript (يعمل دائمًا) ===
function showPage(pageId) {
  // إخفاء جميع العناصر الرئيسية
  const elements = ['welcomeScreen', 'loginPage', 'registerPage', 'appContent'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });

  // إظهار العنصر المطلوب
  if (pageId === 'welcomeScreen' || pageId === 'loginPage' || pageId === 'registerPage') {
    const target = document.getElementById(pageId);
    if (target) target.style.display = 'block';
  } else {
    // صفحات داخل التطبيق
    const appContent = document.getElementById('appContent');
    if (appContent) {
      appContent.style.display = 'block';
      // إخفاء جميع الصفحات الداخلية
      const internalPages = appContent.querySelectorAll('.page');
      internalPages.forEach(page => page.style.display = 'none');
      // إظهار الصفحة المطلوبة
      const internalTarget = document.getElementById(pageId);
      if (internalTarget) internalTarget.style.display = 'block';
    }
  }

  // تحديث الرابط
  window.history.replaceState(null, '', `#${pageId}`);
}

// === Supabase Setup ===
const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // ← استبدلها
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // ← استبدلها
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === Security & Validation Functions ===
function escapeHtml(text) {
  if (typeof text !== 'string') return text;
  const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
  return text.replace(/[&<>"']/g, m => map[m]);
}
function isValidEmail(email) { return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email); }
function isValidPhone(phone) { return /^01[0125][0-9]{8}$/.test(phone); }
function isValidNationalId(id) { return /^\d{14}$/.test(id); }
function getTodayDate() { return new Date().toLocaleDateString('en-CA'); }

// === Global Variables ===
let allRequests = [];
let currentUser = null;
let categoryChart = null;

// === Initialize App ===
$(document).ready(async function() {
  await checkUserSession();
});

// === Session Management ===
async function checkUserSession() {
  const {  { session } } = await supabase.auth.getSession();
  if (session?.user) {
    const {  userData } = await supabase
      .from('users')
      .select('*')
      .eq('id', session.user.id)
      .single();
    if (userData && userData.is_active) {
      currentUser = {
        id: userData.id,
        username: userData.username,
        fullName: userData.full_name,
        email: userData.email,
        role: userData.role
      };
      startApplication();
      return;
    }
  }
  showPage('welcomeScreen');
}

// === Auth Functions ===
function showAuthAlert(message, type, page) {
  const alertDiv = $(`#${page}Alert`);
  alertDiv.removeClass('d-none alert-danger alert-success').addClass(`alert-${type} d-block`).text(message);
  setTimeout(() => alertDiv.addClass('d-none'), 5000);
}

async function loginUser() {
  const email = $('#username').val().trim();
  const password = $('#password').val().trim();
  if (!email || !password) {
    showAuthAlert('الرجاء إدخال البريد وكلمة المرور', 'error', 'login');
    return;
  }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    showAuthAlert('البيانات غير صحيحة', 'error', 'login');
    return;
  }
  const {  userData } = await supabase
    .from('users')
    .select('*')
    .eq('email', email)
    .single();
  if (!userData || !userData.is_active) {
    await supabase.auth.signOut();
    showAuthAlert('حسابك غير مفعل', 'error', 'login');
    return;
  }
  currentUser = {
    id: userData.id,
    username: userData.username,
    fullName: userData.full_name,
    email: userData.email,
    role: userData.role
  };
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  showAuthAlert('تم الدخول بنجاح!', 'success', 'login');
  setTimeout(startApplication, 1500);
}

async function registerUser() {
  const fullName = $('#fullName').val().trim();
  const username = $('#regUsername').val().trim();
  const email = $('#email').val().trim();
  const phone = $('#phone').val().trim();
  const password = $('#regPassword').val();
  const confirmPassword = $('#confirmPassword').val();
  const role = $('#role').val();
  const agreeTerms = $('#agreeTerms').is(':checked');

  if (!fullName || !username || !email || !phone || !password || !confirmPassword || !role || !agreeTerms) {
    showAuthAlert('املأ جميع الحقول', 'error', 'register');
    return;
  }
  if (password !== confirmPassword) {
    showAuthAlert('كلمة المرور غير متطابقة', 'error', 'register');
    return;
  }
  if (!isValidEmail(email)) {
    showAuthAlert('بريد إلكتروني غير صحيح', 'error', 'register');
    return;
  }
  if (!isValidPhone(phone)) {
    showAuthAlert('رقم هاتف غير صحيح', 'error', 'register');
    return;
  }

  const {  authData, error: authError } = await supabase.auth.signUp({
    email, password,
    options: {  { full_name: fullName, username, phone, role } }
  });
  if (authError) {
    showAuthAlert('خطأ في التسجيل: ' + authError.message, 'error', 'register');
    return;
  }

  const { error: insertError } = await supabase.from('users').insert({
    id: authData.user.id,
    username,
    full_name: fullName,
    email,
    phone,
    role,
    is_active: false
  });
  if (insertError) {
    console.error(insertError);
    showAuthAlert('تم التسجيل، لكن حدث خطأ. اتصل بالمسؤول.', 'error', 'register');
    return;
  }

  showAuthAlert('تم التسجيل! سيتم تفعيل الحساب لاحقًا.', 'success', 'register');
  setTimeout(() => { $('#registerPage').hide(); $('#loginPage').show(); }, 2000);
}

// === Data Loading ===
async function loadRequestsFromSupabase() {
  const { data, error } = await supabase
    .from('requests')
    .select('*')
    .order('created_at', { ascending: false });
  if (error) {
    console.error('Error loading requests:', error);
    showNotification('فشل تحميل الطلبات', 'error');
    return [];
  }
  return data || [];
}

// === Save Functions ===
async function saveNewRequest() {
  const nationalId = escapeHtml($('#newNationalId').val().trim());
  const applicantName = escapeHtml($('#newApplicantName').val().trim());
  const category = $('#newCategory').val();
  const priority = $('#newPriority').val();
  const requestTitle = escapeHtml($('#newRequestTitle').val().trim());
  const requestSummary = escapeHtml($('#newRequestSummary').val().trim());

  if (!isValidNationalId(nationalId)) {
    showNotification('الرقم القومي يجب أن يكون 14 رقمًا', 'error');
    return;
  }
  if (!applicantName || !category || !requestTitle || !requestSummary) {
    showNotification('املأ جميع الحقول', 'error');
    return;
  }

  const { error } = await supabase.from('requests').insert({
    id: Date.now(),
    national_id: nationalId,
    applicant_name: applicantName,
    request_title: requestTitle,
    request_summary: requestSummary,
    category,
    status: 'submitted',
    priority,
    created_by: currentUser.email,
    created_at: new Date().toISOString()
  });

  if (error) {
    console.error(error);
    showNotification('فشل حفظ الطلب', 'error');
    return;
  }

  $('#newRequestModal').modal('hide');
  showNotification('تم إضافة الطلب بنجاح', 'success');
  refreshDataFromSupabase();
  await addActivityToSupabase('طلب جديد', `طلب #${Date.now()} بواسطة ${currentUser.fullName}`);
}

async function addActivityToSupabase(title, description) {
  if (!currentUser) return;
  await supabase.from('activities').insert({
    title: escapeHtml(title),
    description: escapeHtml(description),
    user_id: currentUser.id,
    created_at: new Date().toISOString()
  });
}

// === Refresh Data ===
async function refreshDataFromSupabase() {
  allRequests = await loadRequestsFromSupabase();
  renderRequestsTable();
  updateStatistics();
  renderCategoryChart();
  loadUrgentRequests();
}

// === Application Start ===
async function startApplication() {
  $('#welcomeScreen, #loginPage, #registerPage').hide();
  $('#appContent').show();
  $('#currentUserFullName').text(currentUser.fullName);
  $('#profileFullName').text(currentUser.fullName);
  $('#profileRole').text(getRoleLabel(currentUser.role));
  $('#profileEmail').text(currentUser.email);
  $('#settingsFullName').val(currentUser.fullName);
  $('#settingsEmail').val(currentUser.email);
  $('#settingsPhone').val('');

  if (currentUser.role === 'admin') {
    $('#adminMenu, #adminMenu2').show();
  }

  allRequests = await loadRequestsFromSupabase();
  updateUserInterface();
  renderRequestsTable();
  updateStatistics();
  setupMainEventListeners();
  renderCategoryChart();
  loadUrgentRequests();
  initSearchPage();
  initCategoriesPage();
  initReportsPage();
  initSettingsPage();
  initUsersPage();
  initProfilePage();
}

// === UI Rendering Functions ===
function updateUserInterface() {}

function renderRequestsTable() {
  const tbody = $('#requestsTableBody');
  tbody.empty();
  allRequests.forEach(req => {
    const row = $(`
      <tr class="category-${req.category}">
        <td>${req.national_id}</td>
        <td>${req.applicant_name}</td>
        <td>${req.request_title}</td>
        <td>${getCategoryLabel(req.category)}</td>
        <td><span class="priority-${req.priority}">${getPriorityLabel(req.priority)}</span></td>
        <td><span class="status-${req.status}">${getStatusLabel(req.status)}</span></td>
        <td>${req.created_at.split('T')[0]}</td>
        <td>
          <button class="btn btn-sm btn-primary me-1" onclick="viewRequestDetails('${req.id}')">
            <i class="fas fa-eye"></i>
          </button>
          <button class="btn btn-sm btn-success" onclick="updateRequestStatus('${req.id}', 'resolved')">
            <i class="fas fa-check"></i>
          </button>
        </td>
      </tr>
    `);
    tbody.append(row);
  });
}

function updateStatistics() {
  const total = allRequests.length;
  const pending = allRequests.filter(r => r.status === 'submitted' || r.status === 'in-progress').length;
  const resolved = allRequests.filter(r => r.status === 'resolved').length;
  const rejected = allRequests.filter(r => r.status === 'rejected').length;

  $('#totalRequestsCount').text(total);
  $('#pendingRequestsCount').text(pending);
  $('#resolvedRequestsCount').text(resolved);
  $('#rejectedRequestsCount').text(rejected);
}

function renderCategoryChart() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  const categories = ['electricity', 'health', 'education', 'housing', 'employment', 'other'];
  const counts = categories.map(cat => allRequests.filter(r => r.category === cat).length);
  const labels = categories.map(getCategoryLabel);
  const colors = ['#f97316', '#ef4444', '#3b82f6', '#8b5cf6', '#10b981', '#6b7280'];

  if (categoryChart) categoryChart.destroy();
  categoryChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
         counts,
        backgroundColor: colors,
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'bottom' }
      }
    }
  });
}

function loadUrgentRequests() {
  const urgent = allRequests.filter(r => r.priority === 'high').slice(0, 5);
  const list = $('#urgentRequestsList');
  list.empty();
  if (urgent.length === 0) {
    list.html('<p class="text-muted">لا توجد طلبات عاجلة</p>');
    return;
  }
  urgent.forEach(req => {
    list.append(`
      <div class="mb-2 p-2 border rounded">
        <strong>${req.request_title}</strong><br>
        <small class="text-muted">${req.applicant_name} - ${req.created_at.split('T')[0]}</small>
      </div>
    `);
  });
}

// === Helper Functions ===
function getCategoryLabel(category) {
  const labels = {
    electricity: 'كهرباء',
    health: 'صحة',
    education: 'تعليم',
    housing: 'إسكان',
    employment: 'توظيف',
    other: 'أخرى'
  };
  return labels[category] || category;
}

function getPriorityLabel(priority) {
  const labels = { low: 'منخفضة', medium: 'متوسطة', high: 'عالية' };
  return labels[priority] || priority;
}

function getStatusLabel(status) {
  const labels = {
    submitted: 'قيد المراجعة',
    'in-progress': 'قيد التنفيذ',
    resolved: 'تم الحل',
    rejected: 'مرفوض'
  };
  return labels[status] || status;
}

function getRoleLabel(role) {
  const labels = { citizen: 'مواطن', employee: 'موظف', admin: 'مدير النظام' };
  return labels[role] || role;
}

// === Placeholder functions for other pages ===
function initSearchPage() {}
function initCategoriesPage() {}
function initReportsPage() {}
function initSettingsPage() {}
function initUsersPage() {}
function initProfilePage() {}
function setupMainEventListeners() {
  $('#requestsSearch').on('input', function() {
    const term = $(this).val().toLowerCase();
    $('#requestsTableBody tr').filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(term) > -1);
    });
  });
}
function viewRequestDetails(id) { alert('عرض تفاصيل الطلب #' + id); }
function updateRequestStatus(id, status) {
  if (confirm('هل تريد تحديث حالة الطلب إلى "' + getStatusLabel(status) + '"؟')) {
    showNotification('تم تحديث الحالة', 'success');
    refreshDataFromSupabase();
  }
}
function performAdvancedSearch() { alert('بحث متقدم - سيتم تنفيذه لاحقاً'); }
function generateReport() { alert('توليد تقرير - سيتم تنفيذه لاحقاً'); }
function showNewUserModal() { alert('إضافة مستخدم - سيتم تنفيذه لاحقاً'); }
function saveSettings() { alert('حفظ الإعدادات - سيتم تنفيذه لاحقاً'); }

// === Notifications ===
function showNotification(message, type = 'info') {
  const toast = new bootstrap.Toast(document.getElementById('notificationToast'));
  $('#toastMessage').removeClass('text-success text-danger text-warning').addClass(
    type === 'success' ? 'text-success' :
    type === 'error' ? 'text-danger' : 'text-warning'
  ).text(message);
  toast.show();
}

// === Logout ===
async function logout() {
  if (confirm('هل تريد تسجيل الخروج؟')) {
    await supabase.auth.signOut();
    localStorage.removeItem('currentUser');
    currentUser = null;
    showPage('welcomeScreen');
    showNotification('تم تسجيل الخروج بنجاح', 'success');
  }
}

console.log('تم تحميل النظام مع دعم Supabase');
</script>
</body>
</html>
