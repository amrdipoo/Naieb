<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>نظام متابعة طلبات المواطنين - عضو مجلس النواب</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<style>
:root {
--primary-color: #1e3a8a;
--secondary-color: #3b82f6;
--success-color: #10b981;
--warning-color: #f59e0b;
--danger-color: #ef4444;
--light-bg: #f8fafc;
--dark-text: #1e293b;
--card-shadow: 0 4px 6px rgba(0,0,0,0.1);
}
body {
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
background-color: var(--light-bg);
color: var(--dark-text);
direction: rtl;
}
.navbar-brand {
font-weight: bold;
color: white !important;
}
.btn-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
.btn-success { background-color: var(--success-color); border-color: var(--success-color); }
.btn-warning { background-color: var(--warning-color); border-color: var(--warning-color); }
.btn-danger { background-color: var(--danger-color); border-color: var(--danger-color); }
.card { box-shadow: var(--card-shadow); border: none; margin-bottom: 1.5rem; }
.category-electricity { border-right: 4px solid #f97316; }
.category-health { border-right: 4px solid #ef4444; }
.category-education { border-right: 4px solid #3b82f6; }
.category-housing { border-right: 4px solid #8b5cf6; }
.category-employment { border-right: 4px solid #10b981; }
.category-other { border-right: 4px solid #6b7280; }
.priority-high { color: var(--danger-color); font-weight: bold; }
.priority-medium { color: var(--warning-color); }
.priority-low { color: var(--success-color); }
.status-submitted { color: #64748b; }
.status-in-progress { color: var(--warning-color); }
.status-resolved { color: var(--success-color); }
.status-rejected { color: var(--danger-color); }
.welcome-section { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; padding: 4rem 0; text-align: center; }
.feature-card { transition: transform 0.3s ease; }
.feature-card:hover { transform: translateY(-5px); }
.toast { direction: rtl; }
.sidebar { height: 100vh; position: fixed; overflow-y: auto; }
.main-content { margin-right: 250px; padding: 20px; }
@media (max-width: 992px) {
.sidebar { width: 100%; height: auto; position: relative; }
.main-content { margin-right: 0; }
}
</style>
</head>
<body>

<!-- شاشة البداية -->
<div id="welcomeScreen" class="welcome-section">
  <div class="container">
    <h1 class="display-4 fw-bold mb-4">نظام متابعة طلبات المواطنين</h1>
    <p class="lead mb-5">مرحباً بك في النظام الإلكتروني لمتابعة طلبات المواطنين الخاص بعضو مجلس النواب</p>
    <div class="row justify-content-center">
      <div class="col-md-4 mb-4">
        <div class="card feature-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-file-alt fa-2x mb-3 text-primary"></i>
            <h5>تقديم الطلبات</h5>
            <p>قدم طلبك بسهولة وتابع حالته في أي وقت</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card feature-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-chart-bar fa-2x mb-3 text-success"></i>
            <h5>تقارير وإحصائيات</h5>
            <p>احصل على تقارير مفصلة عن الطلبات حسب الفئات</p>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-4">
        <div class="card feature-card h-100">
          <div class="card-body text-center">
            <i class="fas fa-user-shield fa-2x mb-3 text-warning"></i>
            <h5>إدارة آمنة</h5>
            <p>نظام إدارة متكامل للموظفين والمشرفين</p>
          </div>
        </div>
      </div>
    </div>
    <button class="btn btn-light btn-lg me-3" onclick="showPage('loginPage')">
      <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
    </button>
    <button class="btn btn-outline-light btn-lg" onclick="showPage('registerPage')">
      <i class="fas fa-user-plus me-2"></i>إنشاء حساب
    </button>
  </div>
</div>

<!-- صفحة تسجيل الدخول -->
<div id="loginPage" style="display:none; padding: 2rem;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center">
            <h4><i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول</h4>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="loginEmail" class="form-label">البريد الإلكتروني</label>
              <input type="email" class="form-control" id="loginEmail" placeholder="أدخل بريدك الإلكتروني" required>
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label">كلمة المرور</label>
              <input type="password" class="form-control" id="loginPassword" placeholder="أدخل كلمة المرور" required>
            </div>
            <button class="btn btn-primary w-100" onclick="handleLogin()">
              <i class="fas fa-sign-in-alt me-2"></i>دخول
            </button>
            <div class="text-center mt-3">
              <small>ليس لديك حساب؟ <a href="#" onclick="showPage('registerPage')">أنشئ حسابًا</a></small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- صفحة التسجيل -->
<div id="registerPage" style="display:none; padding: 2rem;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header text-center">
            <h4><i class="fas fa-user-plus me-2"></i>إنشاء حساب جديد</h4>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="registerName" class="form-label">الاسم الكامل</label>
              <input type="text" class="form-control" id="registerName" placeholder="أدخل اسمك الكامل" required>
            </div>
            <div class="mb-3">
              <label for="registerEmail" class="form-label">البريد الإلكتروني</label>
              <input type="email" class="form-control" id="registerEmail" placeholder="أدخل بريدك الإلكتروني" required>
            </div>
            <div class="mb-3">
              <label for="registerPassword" class="form-label">كلمة المرور</label>
              <input type="password" class="form-control" id="registerPassword" placeholder="أدخل كلمة مرور قوية" required>
            </div>
            <div class="mb-3">
              <label for="registerConfirmPassword" class="form-label">تأكيد كلمة المرور</label>
              <input type="password" class="form-control" id="registerConfirmPassword" placeholder="أعد إدخال كلمة المرور" required>
            </div>
            <button class="btn btn-success w-100" onclick="handleRegister()">
              <i class="fas fa-user-plus me-2"></i>إنشاء الحساب
            </button>
            <div class="text-center mt-3">
              <small>لديك حساب بالفعل؟ <a href="#" onclick="showPage('loginPage')">سجّل الدخول</a></small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- المحتوى الرئيسي بعد تسجيل الدخول -->
<div id="appContent" style="display:none;">
  <div class="sidebar bg-white p-3">
    <div class="d-flex align-items-center mb-4">
      <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
        <i class="fas fa-user"></i>
      </div>
      <div>
        <div id="userFullName" class="fw-bold">المستخدم</div>
        <small id="userRole" class="text-muted">مواطن</small>
      </div>
    </div>
    <ul class="nav flex-column">
      <li class="nav-item">
        <a class="nav-link active" href="#" onclick="showPage('dashboard'); return false;">
          <i class="fas fa-home me-2"></i>لوحة التحكم
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('submitRequest'); return false;">
          <i class="fas fa-plus-circle me-2"></i>تقديم طلب جديد
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('myRequests'); return false;">
          <i class="fas fa-list me-2"></i>طلباتي
        </a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="#" onclick="showPage('reports'); return false;">
          <i class="fas fa-chart-bar me-2"></i>التقارير والإحصائيات
        </a>
      </li>
      <li class="nav-item mt-4">
        <a class="nav-link text-danger" href="#" onclick="handleLogout(); return false;">
          <i class="fas fa-sign-out-alt me-2"></i>تسجيل الخروج
        </a>
      </li>
    </ul>
  </div>

  <div class="main-content">
    <!-- لوحة التحكم -->
    <div id="dashboard" class="page">
      <h2 class="mb-4">لوحة التحكم</h2>
      <div class="row">
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-primary"><i class="fas fa-file-alt me-2"></i>الطلبات المقدمة</h5>
              <p class="card-text display-6" id="totalRequests">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-warning"><i class="fas fa-spinner me-2"></i>قيد المعالجة</h5>
              <p class="card-text display-6" id="inProgressRequests">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-success"><i class="fas fa-check-circle me-2"></i>تم الحل</h5>
              <p class="card-text display-6" id="resolvedRequests">0</p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card text-center">
            <div class="card-body">
              <h5 class="card-title text-danger"><i class="fas fa-times-circle me-2"></i>مرفوضة</h5>
              <p class="card-text display-6" id="rejectedRequests">0</p>
            </div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-8">
          <div class="card">
            <div class="card-header">
              <h5>آخر الطلبات</h5>
            </div>
            <div class="card-body">
              <div id="recentRequestsList">
                <p class="text-center text-muted">لا توجد طلبات حديثة</p>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-header">
              <h5>الإحصائيات حسب الفئة</h5>
            </div>
            <div class="card-body">
              <canvas id="categoryChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- تقديم طلب جديد -->
    <div id="submitRequest" class="page" style="display:none;">
      <h2 class="mb-4">تقديم طلب جديد</h2>
      <div class="card">
        <div class="card-body">
          <div class="mb-3">
            <label for="requestTitle" class="form-label">عنوان الطلب</label>
            <input type="text" class="form-control" id="requestTitle" placeholder="أدخل عنوانًا موجزًا لطلبك" required>
          </div>
          <div class="mb-3">
            <label for="requestCategory" class="form-label">الفئة</label>
            <select class="form-select" id="requestCategory" required>
              <option value="">اختر الفئة</option>
              <option value="electricity">كهرباء</option>
              <option value="health">صحة</option>
              <option value="education">تعليم</option>
              <option value="housing">إسكان</option>
              <option value="employment">توظيف</option>
              <option value="other">أخرى</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="requestPriority" class="form-label">الأولوية</label>
            <select class="form-select" id="requestPriority" required>
              <option value="low">منخفضة</option>
              <option value="medium">متوسطة</option>
              <option value="high">عالية</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="requestDescription" class="form-label">وصف الطلب</label>
            <textarea class="form-control" id="requestDescription" rows="4" placeholder="صف طلبك بالتفصيل..." required></textarea>
          </div>
          <button class="btn btn-primary" onclick="submitNewRequest()">
            <i class="fas fa-paper-plane me-2"></i>إرسال الطلب
          </button>
        </div>
      </div>
    </div>

    <!-- طلباتي -->
    <div id="myRequests" class="page" style="display:none;">
      <h2 class="mb-4">طلباتي</h2>
      <div class="card">
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>العنوان</th>
                  <th>الفئة</th>
                  <th>الأولوية</th>
                  <th>الحالة</th>
                  <th>تاريخ التقديم</th>
                  <th>الإجراءات</th>
                </tr>
              </thead>
              <tbody id="myRequestsTableBody">
                <tr>
                  <td colspan="6" class="text-center text-muted">لا توجد طلبات</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- التقارير -->
    <div id="reports" class="page" style="display:none;">
      <h2 class="mb-4">التقارير والإحصائيات</h2>
      <div class="row">
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>الطلبات حسب الحالة</h5>
            </div>
            <div class="card-body">
              <canvas id="statusChart" height="200"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card">
            <div class="card-header">
              <h5>الطلبات حسب الأولوية</h5>
            </div>
            <div class="card-body">
              <canvas id="priorityChart" height="200"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast للإشعارات -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
  <div id="notificationToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <strong class="me-auto">إشعار</strong>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body" id="toastMessage"></div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// === Navigation ===
function showPage(pageId) {
  const elements = ['welcomeScreen', 'loginPage', 'registerPage', 'appContent'];
  elements.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  if (['welcomeScreen', 'loginPage', 'registerPage'].includes(pageId)) {
    document.getElementById(pageId).style.display = 'block';
  } else {
    document.getElementById('appContent').style.display = 'block';
    document.querySelectorAll('#appContent .page').forEach(p => p.style.display = 'none');
    document.getElementById(pageId).style.display = 'block';
  }
  window.history.replaceState(null, '', `#${pageId}`);
}

// === Supabase Setup ===
const SUPABASE_URL = 'https://gcgjzqiumgesultletws.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdjZ2p6cWl1bWdlc3VsdGxldHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0Njg1MTksImV4cCI6MjA4NDA0NDUxOX0.ZGQMe3J22-pdlB_zU_jKofk-tR56kWY7TK5JfDB_fJo';
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// === Authentication Functions ===
async function handleLogin() {
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) {
    showToast('يرجى ملء جميع الحقول', 'error');
    return;
  }
  const { data, error } = await supabase.auth.signInWithPassword({ email, password });
  if (error) {
    showToast('خطأ في تسجيل الدخول: ' + error.message, 'error');
    return;
  }
  showToast('تم تسجيل الدخول بنجاح!', 'success');
  loadUserProfile();
  showPage('dashboard');
}

async function handleRegister() {
  const name = document.getElementById('registerName').value;
  const email = document.getElementById('registerEmail').value;
  const password = document.getElementById('registerPassword').value;
  const confirmPassword = document.getElementById('registerConfirmPassword').value;
  if (!name || !email || !password || !confirmPassword) {
    showToast('يرجى ملء جميع الحقول', 'error');
    return;
  }
  if (password !== confirmPassword) {
    showToast('كلمتا المرور غير متطابقتين', 'error');
    return;
  }
  const { data, error } = await supabase.auth.signUp({
    email,
    password,
    options: { data: { full_name: name } }
  });
  if (error) {
    showToast('خطأ في التسجيل: ' + error.message, 'error');
    return;
  }
  showToast('تم إنشاء الحساب بنجاح! يرجى التحقق من بريدك الإلكتروني.', 'success');
  showPage('loginPage');
}

async function handleLogout() {
  const { error } = await supabase.auth.signOut();
  if (error) {
    showToast('خطأ في تسجيل الخروج: ' + error.message, 'error');
    return;
  }
  showPage('welcomeScreen');
}

// === Profile and Data Loading ===
async function loadUserProfile() {
  const { data: { user } } = await supabase.auth.getUser();
  if (user) {
    document.getElementById('userFullName').textContent = user.user_metadata.full_name || user.email;
    document.getElementById('userRole').textContent = 'مواطن';
  }
}

// === Request Functions ===
async function submitNewRequest() {
  const title = document.getElementById('requestTitle').value;
  const category = document.getElementById('requestCategory').value;
  const priority = document.getElementById('requestPriority').value;
  const description = document.getElementById('requestDescription').value;
  if (!title || !category || !priority || !description) {
    showToast('يرجى ملء جميع الحقول', 'error');
    return;
  }
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) {
    showToast('يجب تسجيل الدخول أولاً', 'error');
    return;
  }
  const { error } = await supabase.from('requests').insert([
    { user_id: user.id, title, category, priority, description, status: 'submitted' }
  ]);
  if (error) {
    showToast('خطأ في إرسال الطلب: ' + error.message, 'error');
    return;
  }
  showToast('تم إرسال الطلب بنجاح!', 'success');
  document.getElementById('requestTitle').value = '';
  document.getElementById('requestCategory').value = '';
  document.getElementById('requestPriority').value = 'low';
  document.getElementById('requestDescription').value = '';
  loadDashboardData();
}

async function loadDashboardData() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return;
  
  // Total requests
  const { count: total } = await supabase.from('requests').select('*', { count: 'exact', head: true }).eq('user_id', user.id);
  document.getElementById('totalRequests').textContent = total || 0;
  
  // In progress
  const { count: inProgress } = await supabase.from('requests').select('*', { count: 'exact', head: true }).eq('user_id', user.id).eq('status', 'in_progress');
  document.getElementById('inProgressRequests').textContent = inProgress || 0;
  
  // Resolved
  const { count: resolved } = await supabase.from('requests').select('*', { count: 'exact', head: true }).eq('user_id', user.id).eq('status', 'resolved');
  document.getElementById('resolvedRequests').textContent = resolved || 0;
  
  // Rejected
  const { count: rejected } = await supabase.from('requests').select('*', { count: 'exact', head: true }).eq('user_id', user.id).eq('status', 'rejected');
  document.getElementById('rejectedRequests').textContent = rejected || 0;
  
  // Recent requests
  const { data: recent } = await supabase.from('requests').select('*').eq('user_id', user.id).order('created_at', { ascending: false }).limit(5);
  const recentList = document.getElementById('recentRequestsList');
  if (recent.length === 0) {
    recentList.innerHTML = '<p class="text-center text-muted">لا توجد طلبات حديثة</p>';
  } else {
    recentList.innerHTML = recent.map(r => 
      `<div class="d-flex justify-content-between py-2 border-bottom">
        <div><strong>${r.title}</strong><br><small class="text-muted">${r.category} - ${r.priority}</small></div>
        <div class="status-${r.status}">${r.status === 'submitted' ? 'مُقدَّم' : r.status === 'in_progress' ? 'قيد المعالجة' : r.status === 'resolved' ? 'تم الحل' : 'مرفوض'}</div>
      </div>`
    ).join('');
  }
  
  // Charts
  renderCategoryChart();
  renderStatusChart();
  renderPriorityChart();
}

// === Chart Rendering ===
function renderCategoryChart() {
  const ctx = document.getElementById('categoryChart').getContext('2d');
  // Placeholder data - replace with real data from Supabase
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['كهرباء', 'صحة', 'تعليم', 'إسكان', 'توظيف', 'أخرى'],
      datasets: [{
        data: [12, 19, 3, 5, 2, 8],
        backgroundColor: ['#f97316', '#ef4444', '#3b82f6', '#8b5cf6', '#10b981', '#6b7280']
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function renderStatusChart() {
  const ctx = document.getElementById('statusChart').getContext('2d');
  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['مُقدَّم', 'قيد المعالجة', 'تم الحل', 'مرفوض'],
      datasets: [{
        label: 'عدد الطلبات',
        data: [15, 8, 12, 3],
        backgroundColor: ['#64748b', '#f59e0b', '#10b981', '#ef4444']
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

function renderPriorityChart() {
  const ctx = document.getElementById('priorityChart').getContext('2d');
  new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['عالية', 'متوسطة', 'منخفضة'],
      datasets: [{
        data: [5, 10, 20],
        backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
      }]
    },
    options: { responsive: true, maintainAspectRatio: false }
  });
}

// === Utility Functions ===
function showToast(message, type = 'info') {
  const toast = document.getElementById('notificationToast');
  const toastBody = document.getElementById('toastMessage');
  toastBody.textContent = message;
  toast.className = `toast ${type === 'error' ? 'text-bg-danger' : type === 'success' ? 'text-bg-success' : 'text-bg-info'} show`;
  setTimeout(() => {
    toast.classList.remove('show');
  }, 3000);
}

// === Initialize ===
document.addEventListener('DOMContentLoaded', () => {
  const { data: { session } } = supabase.auth.getSession();
  if (session) {
    loadUserProfile();
    loadDashboardData();
    showPage('dashboard');
  } else {
    showPage('welcomeScreen');
  }
  
  // Handle URL hash navigation
  window.addEventListener('hashchange', () => {
    const pageId = window.location.hash.substring(1) || 'welcomeScreen';
    if (['welcomeScreen', 'loginPage', 'registerPage', 'dashboard', 'submitRequest', 'myRequests', 'reports'].includes(pageId)) {
      showPage(pageId);
    }
  });
});

console.log('تم تحميل النظام مع دعم Supabase');
</script>
</body>
</html>