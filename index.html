<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة طلبات المواطنين - عضو مجلس النواب</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --electricity-color: #f97316;
            --health-color: #ec4899;
            --water-color: #0ea5e9;
            --sanitation-color: #8b5cf6;
            --education-color: #84cc16;
            --transport-color: #6366f1;
            --telecom-color: #06b6d4;
            --housing-color: #14b8a6;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            transition: all 0.3s;
        }
        
        /* شاشة الترحيب */
        .welcome-screen {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .welcome-title {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .welcome-subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .welcome-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* تسجيل الدخول */
        .auth-page {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }
        
        .auth-container {
            width: 100%;
            max-width: 450px;
        }
        
        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .auth-body {
            padding: 30px;
        }
        
        /* التطبيق الرئيسي */
        .app-content {
            display: none;
            background-color: #f8fafc;
            min-height: 100vh;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #1e40af 100%);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 5px 15px;
            border-radius: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(-5px);
        }
        
        .nav-link i {
            width: 25px;
            text-align: center;
            margin-left: 10px;
        }
        
        .main-content {
            margin-right: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-header h3,
            .nav-link span {
                display: none;
            }
            
            .main-content {
                margin-right: 70px;
            }
            
            .nav-link {
                justify-content: center;
                padding: 15px;
                margin: 5px 10px;
            }
            
            .nav-link i {
                margin-left: 0;
            }
        }
        
        /* إحصائيات */
        .stat-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        /* أزرار الحالة */
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-submitted { background-color: #dbeafe; color: var(--primary-color); }
        .status-pending { background-color: #fef3c7; color: var(--warning-color); }
        .status-approved { background-color: #d1fae5; color: var(--success-color); }
        .status-rejected { background-color: #fee2e2; color: var(--danger-color); }
        
        /* أزرار الفئات */
        .category-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .category-electricity { background-color: #ffedd5; color: var(--electricity-color); border-left: 4px solid var(--electricity-color); }
        .category-health { background-color: #fce7f3; color: var(--health-color); border-left: 4px solid var(--health-color); }
        .category-water { background-color: #e0f2fe; color: var(--water-color); border-left: 4px solid var(--water-color); }
        .category-sanitation { background-color: #f3e8ff; color: var(--sanitation-color); border-left: 4px solid var(--sanitation-color); }
        .category-education { background-color: #f0fdf4; color: var(--education-color); border-left: 4px solid var(--education-color); }
        .category-transport { background-color: #eef2ff; color: var(--transport-color); border-left: 4px solid var(--transport-color); }
        .category-telecom { background-color: #ecfeff; color: var(--telecom-color); border-left: 4px solid var(--telecom-color); }
        .category-housing { background-color: #f0fdfa; color: var(--housing-color); border-left: 4px solid var(--housing-color); }
        
        /* زر الإضافة */
        .add-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.4);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.6);
        }
        
        /* زر GitHub */
        .github-badge {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1050;
        }
        
        /* مؤشر المزامنة */
        .sync-status {
            position: fixed;
            bottom: 80px;
            left: 30px;
            z-index: 1050;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 20px;
            padding: 8px 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .sync-indicator.syncing {
            background: linear-gradient(135deg, #3b82f6, #1e3a8a);
            color: white;
        }
        
        .sync-indicator.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .sync-indicator.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .sync-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* الصفحات */
        .page-section {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* تعديلات للجداول */
        .table th {
            border-top: none;
            font-weight: 600;
            color: #4b5563;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        /* تلميحات التنقل */
        .nav-tabs .nav-link {
            color: #6b7280;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            border-color: var(--primary-color);
            font-weight: 600;
        }
        
        /* محتوى الصفحات المخفي افتراضيًا */
        .page-section {
            display: none;
        }
        
        .page-section.active {
            display: block;
        }
        
        /* تحسين الأزرار */
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
        }
    </style>
</head>
<body>
    <!-- شاشة الترحيب -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-logo">
            <i class="fas fa-hands-helping"></i>
        </div>
        <h1 class="welcome-title">نظام متابعة طلبات المواطنين</h1>
        <p class="welcome-subtitle">عضو مجلس النواب</p>
        <div class="welcome-buttons">
            <button class="btn btn-light btn-lg" id="loginWelcomeBtn">
                <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
            </button>
            <button class="btn btn-outline-light btn-lg" id="registerWelcomeBtn">
                <i class="fas fa-user-plus me-2"></i>إنشاء حساب جديد
            </button>
        </div>
    </div>

    <!-- صفحة تسجيل الدخول -->
    <div id="loginPage" class="auth-page" style="display: none;">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="logo">
                        <i class="fas fa-hands-helping"></i>
                    </div>
                    <h1>تسجيل الدخول</h1>
                    <p>نظام متابعة طلبات المواطنين</p>
                </div>
                <div class="auth-body">
                    <div id="loginAlert" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="loginAlertMessage"></span>
                    </div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">
                                <i class="fas fa-user me-2"></i>اسم المستخدم
                            </label>
                            <input type="text" class="form-control" id="username" placeholder="أدخل اسم المستخدم" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2"></i>كلمة المرور
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="password" placeholder="أدخل كلمة المرور" required>
                                <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2" id="loginBtn">
                            <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
                        </button>
                        <div class="text-center mt-3">
                            <a href="#" id="showRegisterLink">إنشاء حساب جديد</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة إنشاء حساب -->
    <div id="registerPage" class="auth-page" style="display: none;">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="logo">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h1>إنشاء حساب جديد</h1>
                    <p>انضم إلى نظام متابعة طلبات المواطنين</p>
                </div>
                <div class="auth-body">
                    <div id="registerAlert" class="alert alert-danger d-none">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="registerAlertMessage"></span>
                    </div>
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">الاسم الكامل</label>
                                <input type="text" class="form-control" id="fullName" placeholder="أدخل الاسم الكامل" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="regUsername" class="form-label">اسم المستخدم</label>
                                <input type="text" class="form-control" id="regUsername" placeholder="أدخل اسم المستخدم" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" id="regPassword" placeholder="أدخل كلمة المرور" required>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">تأكيد كلمة المرور</label>
                            <input type="password" class="form-control" id="confirmPassword" placeholder="أعد إدخال كلمة المرور" required>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">الدور الوظيفي</label>
                            <select class="form-select" id="role" required>
                                <option value="">اختر الدور الوظيفي</option>
                                <option value="assistant">مساعد عضو مجلس النواب</option>
                                <option value="coordinator">منسق طلبات</option>
                                <option value="viewer">مستعرض</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2" id="registerBtn">
                            <i class="fas fa-user-plus me-2"></i>إنشاء حساب
                        </button>
                        <div class="text-center mt-3">
                            <a href="#" id="showLoginLink">لديك حساب بالفعل؟ تسجيل الدخول</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="appContent" class="app-content" style="display: none;">
        <!-- الشريط الجانبي -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="user-info text-center">
                    <div class="user-avatar mb-3">
                        <i class="fas fa-user-circle fa-2x"></i>
                    </div>
                    <h6 id="sidebarUserName">عضو مجلس النواب</h6>
                    <small id="sidebarUserRole" class="text-white-50">المسؤول</small>
                </div>
            </div>
            <ul class="nav flex-column mt-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="allRequests">
                        <i class="fas fa-list"></i>
                        <span>جميع الطلبات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="search">
                        <i class="fas fa-search"></i>
                        <span>بحث متقدم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="categories">
                        <i class="fas fa-layer-group"></i>
                        <span>الهيئات الحكومية</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="profile">
                        <i class="fas fa-user-circle"></i>
                        <span>الملف الشخصي</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" data-page="settings">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>
                </li>
            </ul>
            <div class="mt-auto p-3">
                <button class="btn btn-sm btn-outline-light w-100" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </nav>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <!-- لوحة التحكم -->
            <div id="dashboardSection" class="page-section active">
                <!-- شريط البحث -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8 mb-3 mb-md-0">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="mainSearchInput" placeholder="ابحث بالرقم القومي أو اسم مقدم الطلب...">
                                            <button class="btn btn-primary" type="button" id="searchBtn">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-flex gap-2">
                                            <select class="form-select" id="searchType">
                                                <option value="both">بحث شامل</option>
                                                <option value="nationalId">رقم قومي</option>
                                                <option value="name">اسم مقدم</option>
                                            </select>
                                            <button class="btn btn-primary" id="newRequestBtn">
                                                <i class="fas fa-plus me-1"></i>جديد
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الإحصائيات -->
                <div class="row mb-4">
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card border-start-primary border-start-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <div class="text-xs fw-bold text-primary text-uppercase mb-1">إجمالي الطلبات</div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="totalRequests">0</div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="stat-icon bg-primary text-white">
                                            <i class="fas fa-file-alt"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card border-start-success border-start-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <div class="text-xs fw-bold text-success text-uppercase mb-1">طلبات جديدة</div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="newRequests">0</div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="stat-icon bg-success text-white">
                                            <i class="fas fa-plus-circle"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card border-start-warning border-start-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <div class="text-xs fw-bold text-warning text-uppercase mb-1">قيد الانتظار</div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="pendingRequests">0</div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="stat-icon bg-warning text-white">
                                            <i class="fas fa-clock"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-xl-3 col-md-6 mb-4">
                        <div class="card stat-card border-start-info border-start-4">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <div class="text-xs fw-bold text-info text-uppercase mb-1">نسبة الإنجاز</div>
                                        <div class="h5 mb-0 fw-bold text-gray-800" id="completionRate">0%</div>
                                    </div>
                                    <div class="col-4 text-end">
                                        <div class="stat-icon bg-info text-white">
                                            <i class="fas fa-chart-line"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- جدول الطلبات -->
                <div class="card shadow-sm">
                    <div class="card-header py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="m-0 fw-bold text-primary">
                                <i class="fas fa-list me-2"></i>
                                <span id="resultsTitle">الطلبات الأخيرة</span>
                            </h6>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                                    <i class="fas fa-redo"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" id="exportBtn">
                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>الرقم القومي</th>
                                        <th>اسم مقدم الطلب</th>
                                        <th>عنوان الطلب</th>
                                        <th>الهيئة</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody">
                                    <!-- البيانات تظهر هنا -->
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center py-4" id="noResultsMessage" style="display: none;">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">لا توجد نتائج للبحث</h5>
                        </div>
                    </div>
                </div>
            </div>

            <!-- جميع الطلبات -->
            <div id="allRequestsSection" class="page-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>جميع الطلبات
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>قائمة بجميع الطلبات المخزنة في النظام...</p>
                    </div>
                </div>
            </div>

            <!-- البحث المتقدم -->
            <div id="searchSection" class="page-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-search-plus me-2"></i>بحث متقدم
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="advancedSearchForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="advNationalId" class="form-label">الرقم القومي</label>
                                    <input type="text" class="form-control" id="advNationalId" maxlength="14">
                                </div>
                                <div class="col-md-6">
                                    <label for="advApplicantName" class="form-label">اسم مقدم الطلب</label>
                                    <input type="text" class="form-control" id="advApplicantName">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="advCategory" class="form-label">الهيئة الحكومية</label>
                                    <select class="form-select" id="advCategory">
                                        <option value="">كل الهيئات</option>
                                        <option value="electricity">كهرباء</option>
                                        <option value="health">صحة</option>
                                        <option value="water">مياه</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="advStatus" class="form-label">حالة الطلب</label>
                                    <select class="form-select" id="advStatus">
                                        <option value="">كل الحالات</option>
                                        <option value="submitted">تم التقديم</option>
                                        <option value="pending">انتظار الرد</option>
                                        <option value="approved">موافقة</option>
                                        <option value="rejected">غير موافقة</option>
                                    </select>
                                </div>
                            </div>
                            <button type="button" class="btn btn-primary" id="executeAdvancedSearch">
                                <i class="fas fa-search me-2"></i>بحث
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- الهيئات الحكومية -->
            <div id="categoriesSection" class="page-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-layer-group me-2"></i>الهيئات الحكومية
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3" id="categoriesGrid">
                            <!-- الهيئات تظهر هنا -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- التقارير -->
            <div id="reportsSection" class="page-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>التقارير
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>التقارير والإحصائيات الشاملة...</p>
                    </div>
                </div>
            </div>

            <!-- الملف الشخصي -->
            <div id="profileSection" class="page-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-user-circle me-2"></i>الملف الشخصي
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>معلومات الملف الشخصي...</p>
                    </div>
                </div>
            </div>

            <!-- الإعدادات -->
            <div id="settingsSection" class="page-section">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-cog me-2"></i>الإعدادات
                        </h5>
                    </div>
                    <div class="card-body">
                        <p>إعدادات النظام...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- زر إضافة طلب جديد -->
        <button class="add-btn" id="floatingAddBtn">
            <i class="fas fa-plus fa-lg"></i>
        </button>
    </div>

    <!-- شارة GitHub -->
    <div class="github-badge">
        <button class="btn btn-dark btn-sm" id="githubSyncBtn" title="إعدادات المزامنة">
            <i class="fab fa-github"></i>
            <span class="d-none d-md-inline"> Sync</span>
        </button>
    </div>

    <!-- مؤشر المزامنة -->
    <div class="sync-status" id="syncStatus" style="display: none;">
        <div class="sync-indicator" id="syncIndicator">
            <i class="fas fa-sync sync-spinner me-2"></i>
            <span id="syncMessage">جاري المزامنة...</span>
        </div>
    </div>

    <!-- نموذج إعدادات GitHub -->
    <div class="modal fade" id="githubConfigModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">
                        <i class="fab fa-github me-2"></i>إعدادات GitHub
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="githubConfigAlert" class="alert d-none"></div>
                    
                    <div class="mb-3">
                        <label for="githubToken" class="form-label">GitHub Token</label>
                        <input type="password" class="form-control" id="githubToken" placeholder="أدخل الـ Token">
                    </div>
                    
                    <div class="mb-3">
                        <label for="githubUsername" class="form-label">اسم المستخدم</label>
                        <input type="text" class="form-control" id="githubUsername" placeholder="أدخل اسم المستخدم">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoSyncEnabled" checked>
                        <label class="form-check-label" for="autoSyncEnabled">المزامنة التلقائية</label>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary flex-fill" id="testGithubConnection">
                            <i class="fas fa-plug me-2"></i>اختبار
                        </button>
                        <button class="btn btn-primary flex-fill" id="saveGithubConfig">
                            <i class="fas fa-save me-2"></i>حفظ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== تعريف البيانات ====================
        const categories = {
            'electricity': {
                name: 'كهرباء',
                color: '#f97316',
                bgColor: '#ffedd5',
                icon: 'fas fa-bolt',
                description: 'وزارة الكهرباء والطاقة المتجددة'
            },
            'health': {
                name: 'صحة',
                color: '#ec4899',
                bgColor: '#fce7f3',
                icon: 'fas fa-hospital',
                description: 'وزارة الصحة والسكان'
            },
            'water': {
                name: 'مياه',
                color: '#0ea5e9',
                bgColor: '#e0f2fe',
                icon: 'fas fa-tint',
                description: 'وزارة الموارد المائية والري'
            },
            'sanitation': {
                name: 'صرف صحي',
                color: '#8b5cf6',
                bgColor: '#f3e8ff',
                icon: 'fas fa-toilet',
                description: 'وزارة الإسكان والمرافق والمجتمعات العمرانية'
            },
            'education': {
                name: 'تعليم',
                color: '#84cc16',
                bgColor: '#f0fdf4',
                icon: 'fas fa-graduation-cap',
                description: 'وزارة التربية والتعليم'
            },
            'transport': {
                name: 'مواصلات',
                color: '#6366f1',
                bgColor: '#eef2ff',
                icon: 'fas fa-bus',
                description: 'وزارة النقل'
            },
            'telecom': {
                name: 'اتصالات',
                color: '#06b6d4',
                bgColor: '#ecfeff',
                icon: 'fas fa-wifi',
                description: 'وزارة الاتصالات وتكنولوجيا المعلومات'
            },
            'housing': {
                name: 'إسكان',
                color: '#14b8a6',
                bgColor: '#f0fdfa',
                icon: 'fas fa-home',
                description: 'وزارة الإسكان والمرافق والمجتمعات العمرانية'
            }
        };

        const statuses = {
            'submitted': {
                name: 'تم التقديم',
                color: '#3b82f6',
                bgColor: '#dbeafe',
                icon: 'fas fa-file-import'
            },
            'pending': {
                name: 'انتظار الرد',
                color: '#f59e0b',
                bgColor: '#fef3c7',
                icon: 'fas fa-clock'
            },
            'approved': {
                name: 'موافقة',
                color: '#10b981',
                bgColor: '#d1fae5',
                icon: 'fas fa-check-circle'
            },
            'rejected': {
                name: 'غير موافقة',
                color: '#ef4444',
                bgColor: '#fee2e2',
                icon: 'fas fa-times-circle'
            }
        };

        // بيانات التطبيق
        let allRequests = JSON.parse(localStorage.getItem('citizenRequests')) || [
            {
                id: 1001,
                nationalId: "29801011234567",
                applicantName: "أحمد محمد علي",
                requestTitle: "طلب توصيل خدمة كهرباء",
                requestSummary: "المنطقة التي أسكن بها تفتقد لخدمة الكهرباء منذ ثلاثة أشهر.",
                requestDate: "2023-12-15",
                category: "electricity",
                status: "pending",
                priority: "high",
                createdAt: new Date().toISOString()
            },
            {
                id: 1002,
                nationalId: "29905052345678",
                applicantName: "سارة خالد حسن",
                requestTitle: "طلب إنشاء مركز صحي",
                requestSummary: "الحاجة إلى مركز صحي في الحي الجديد لخدمة المواطنين.",
                requestDate: "2023-12-10",
                category: "health",
                status: "approved",
                priority: "medium",
                createdAt: new Date().toISOString()
            }
        ];

        let currentUser = null;
        let filteredRequests = [...allRequests];

        // ==================== إعدادات GitHub ====================
        let githubConfig = JSON.parse(localStorage.getItem('githubConfig')) || {
            token: '',
            username: '',
            gistId: '',
            autoSync: true,
            syncOnStartup: true,
            lastSync: null
        };

        let isSyncing = false;

        // ==================== تهيئة التطبيق ====================
        $(document).ready(function() {
            initializeAuth();
            initializeGitHub();
            checkUserSession();
        });

        // ==================== نظام المصادقة ====================
        function initializeAuth() {
            if (!localStorage.getItem('systemUsers')) {
                const defaultUsers = [
                    {
                        id: 1,
                        username: 'admin',
                        password: '123456',
                        fullName: 'عضو مجلس النواب',
                        email: 'mp@parliament.gov',
                        phone: '01012345678',
                        role: 'admin',
                        isActive: true,
                        createdAt: new Date().toISOString()
                    }
                ];
                localStorage.setItem('systemUsers', JSON.stringify(defaultUsers));
            }
            
            setupAuthEvents();
        }

        function setupAuthEvents() {
            // شاشة الترحيب
            $('#loginWelcomeBtn').click(function() {
                $('#welcomeScreen').hide();
                $('#loginPage').show();
            });
            
            $('#registerWelcomeBtn').click(function() {
                $('#welcomeScreen').hide();
                $('#registerPage').show();
            });
            
            // التنقل بين الصفحات
            $('#showRegisterLink').click(function(e) {
                e.preventDefault();
                $('#loginPage').hide();
                $('#registerPage').show();
            });
            
            $('#showLoginLink').click(function(e) {
                e.preventDefault();
                $('#registerPage').hide();
                $('#loginPage').show();
            });
            
            // تسجيل الدخول
            $('#loginForm').submit(function(e) {
                e.preventDefault();
                loginUser();
            });
            
            // إنشاء حساب
            $('#registerForm').submit(function(e) {
                e.preventDefault();
                registerUser();
            });
            
            // تبديل رؤية كلمة المرور
            $('#togglePassword').click(function() {
                const input = $('#password');
                const icon = $(this).find('i');
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
        }

        function loginUser() {
            const username = $('#username').val().trim();
            const password = $('#password').val().trim();
            
            if (!username || !password) {
                showAuthAlert('الرجاء إدخال اسم المستخدم وكلمة المرور', 'error', 'login');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (!user) {
                showAuthAlert('اسم المستخدم أو كلمة المرور غير صحيحة', 'error', 'login');
                return;
            }
            
            if (!user.isActive) {
                showAuthAlert('حسابك غير مفعل', 'error', 'login');
                return;
            }
            
            currentUser = {
                id: user.id,
                username: user.username,
                fullName: user.fullName,
                role: user.role,
                loggedInAt: new Date().toISOString()
            };
            
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            startApplication();
        }

        function registerUser() {
            const fullName = $('#fullName').val().trim();
            const username = $('#regUsername').val().trim();
            const password = $('#regPassword').val();
            const confirmPassword = $('#confirmPassword').val();
            const role = $('#role').val();
            
            // التحقق من البيانات
            if (!fullName || !username || !password || !confirmPassword || !role) {
                showAuthAlert('الرجاء ملء جميع الحقول', 'error', 'register');
                return;
            }
            
            if (password !== confirmPassword) {
                showAuthAlert('كلمات المرور غير متطابقة', 'error', 'register');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            
            // التحقق من عدم تكرار اسم المستخدم
            if (users.some(u => u.username === username)) {
                showAuthAlert('اسم المستخدم مستخدم مسبقاً', 'error', 'register');
                return;
            }
            
            const newUser = {
                id: users.length + 1,
                username: username,
                password: password,
                fullName: fullName,
                role: role,
                isActive: true,
                createdAt: new Date().toISOString()
            };
            
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            showAuthAlert('تم إنشاء الحساب بنجاح', 'success', 'register');
            
            setTimeout(() => {
                $('#registerPage').hide();
                $('#loginPage').show();
            }, 1500);
        }

        function showAuthAlert(message, type, page) {
            const alertDiv = $(`#${page}Alert`);
            alertDiv.removeClass('d-none alert-danger alert-success alert-info')
                    .addClass(`alert-${type}`)
                    .html(`<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`);
        }

        function checkUserSession() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                try {
                    currentUser = JSON.parse(userData);
                    startApplication();
                } catch (e) {
                    localStorage.removeItem('currentUser');
                }
            }
        }

        // ==================== نظام GitHub ====================
        function initializeGitHub() {
            // زر GitHub
            $('#githubSyncBtn').click(function() {
                loadGitHubConfig();
                $('#githubConfigModal').modal('show');
            });
            
            // اختبار الاتصال
            $('#testGithubConnection').click(async function() {
                await testGitHubConnection();
            });
            
            // حفظ الإعدادات
            $('#saveGithubConfig').click(function() {
                saveGitHubConfig();
            });
        }

        function loadGitHubConfig() {
            $('#githubToken').val(githubConfig.token || '');
            $('#githubUsername').val(githubConfig.username || '');
            $('#autoSyncEnabled').prop('checked', githubConfig.autoSync !== false);
        }

        async function testGitHubConnection() {
            const token = $('#githubToken').val().trim();
            const username = $('#githubUsername').val().trim();
            
            if (!token || !username) {
                showGitHubAlert('الرجاء إدخال Token واسم المستخدم', 'warning');
                return;
            }
            
            showGitHubAlert('جاري اختبار الاتصال...', 'info');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`خطأ ${response.status}`);
                }
                
                const userData = await response.json();
                
                if (userData.login !== username) {
                    throw new Error('اسم المستخدم غير مطابق');
                }
                
                showGitHubAlert('تم الاتصال بنجاح!', 'success');
                
                // البحث عن Gist موجود أو إنشاء جديد
                await findOrCreateGist(token);
                
            } catch (error) {
                showGitHubAlert(`فشل الاتصال: ${error.message}`, 'danger');
            }
        }

        async function findOrCreateGist(token) {
            try {
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('فشل في جلب Gists');
                }
                
                const gists = await response.json();
                const existingGist = gists.find(g => g.description === 'Citizen Requests System Data');
                
                if (existingGist) {
                    githubConfig.gistId = existingGist.id;
                    showGitHubAlert('تم العثور على تخزين بيانات موجود', 'success');
                } else {
                    await createNewGist(token);
                }
                
                localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                
            } catch (error) {
                console.error('Gist error:', error);
            }
        }

        async function createNewGist(token) {
            const data = {
                requests: allRequests,
                users: JSON.parse(localStorage.getItem('systemUsers') || '[]'),
                lastSync: new Date().toISOString()
            };
            
            const gistData = {
                description: 'Citizen Requests System Data',
                public: false,
                files: {
                    'citizen-requests-data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    githubConfig.gistId = gist.id;
                    showGitHubAlert('تم إنشاء تخزين بيانات جديد', 'success');
                }
            } catch (error) {
                console.error('Create gist error:', error);
            }
        }

        function saveGitHubConfig() {
            githubConfig.token = $('#githubToken').val();
            githubConfig.username = $('#githubUsername').val();
            githubConfig.autoSync = $('#autoSyncEnabled').is(':checked');
            
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            showGitHubAlert('تم حفظ الإعدادات بنجاح', 'success');
            
            setTimeout(() => {
                $('#githubConfigModal').modal('hide');
            }, 1500);
        }

        function showGitHubAlert(message, type) {
            const alert = $('#githubConfigAlert');
            alert.removeClass('d-none alert-warning alert-success alert-danger alert-info')
                 .addClass(`alert-${type}`)
                 .html(`<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`);
        }

        // المزامنة إلى GitHub
        async function syncToGist(manual = false) {
            if (!githubConfig.token || !githubConfig.gistId) {
                if (manual) showNotification('لم يتم تكوين اتصال GitHub', 'warning');
                return;
            }
            
            if (isSyncing) {
                if (manual) showNotification('جاري المزامنة حالياً', 'info');
                return;
            }
            
            isSyncing = true;
            showSyncStatus('جاري المزامنة مع GitHub...', 'syncing');
            
            try {
                const data = {
                    requests: allRequests,
                    users: JSON.parse(localStorage.getItem('systemUsers') || '[]'),
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };
                
                const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'citizen-requests-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`فشل المزامنة: ${response.status}`);
                }
                
                githubConfig.lastSync = new Date().toISOString();
                localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                
                showSyncStatus('تمت المزامنة بنجاح', 'success');
                if (manual) showNotification('تم حفظ البيانات على GitHub', 'success');
                
                setTimeout(hideSyncStatus, 3000);
                
            } catch (error) {
                showSyncStatus('فشلت المزامنة', 'error');
                if (manual) showNotification(`فشلت المزامنة: ${error.message}`, 'danger');
                setTimeout(hideSyncStatus, 5000);
            } finally {
                isSyncing = false;
            }
        }

        // المزامنة من GitHub
        async function syncFromGist() {
            if (!githubConfig.token || !githubConfig.gistId) return;
            
            if (isSyncing) return;
            isSyncing = true;
            showSyncStatus('جاري جلب البيانات...', 'syncing');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`فشل جلب البيانات: ${response.status}`);
                }
                
                const gist = await response.json();
                const content = gist.files['citizen-requests-data.json'].content;
                const data = JSON.parse(content);
                
                if (data.requests) {
                    allRequests = data.requests;
                    localStorage.setItem('citizenRequests', JSON.stringify(allRequests));
                }
                
                githubConfig.lastSync = new Date().toISOString();
                localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                
                showSyncStatus('تم جلب البيانات بنجاح', 'success');
                showNotification('تم تحديث البيانات من GitHub', 'success');
                
                refreshData();
                setTimeout(hideSyncStatus, 3000);
                
            } catch (error) {
                showSyncStatus('فشل جلب البيانات', 'error');
                setTimeout(hideSyncStatus, 5000);
            } finally {
                isSyncing = false;
            }
        }

        function showSyncStatus(message, status) {
            const indicator = $('#syncIndicator');
            $('#syncStatus').show();
            indicator.removeClass('syncing success error').addClass(status);
            $('#syncMessage').text(message);
        }

        function hideSyncStatus() {
            $('#syncStatus').hide();
        }

        // المزامنة التلقائية
        function autoSync() {
            if (githubConfig.autoSync && githubConfig.token && githubConfig.gistId) {
                setTimeout(syncToGist, 2000);
            }
        }

        // المزامنة عند بدء التشغيل
        function startupSync() {
            if (githubConfig.syncOnStartup && githubConfig.token && githubConfig.gistId) {
                setTimeout(syncFromGist, 1000);
            }
        }

        // ==================== التطبيق الرئيسي ====================
        function startApplication() {
            $('#welcomeScreen').hide();
            $('#loginPage').hide();
            $('#registerPage').hide();
            $('#appContent').show();
            
            updateUserInterface();
            setupAppEvents();
            renderRequestsTable();
            updateStatistics();
            renderCategoriesGrid();
            
            // إعداد استماع للتغييرات للمزامنة
            $(document).on('requestChanged', autoSync);
            
            // المزامنة عند بدء التشغيل
            startupSync();
        }

        function updateUserInterface() {
            if (currentUser) {
                $('#sidebarUserName').text(currentUser.fullName);
                $('#sidebarUserRole').text(getRoleName(currentUser.role));
            }
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'المسؤول',
                'assistant': 'مساعد',
                'coordinator': 'منسق',
                'viewer': 'مستعرض'
            };
            return roles[role] || 'مستخدم';
        }

        function setupAppEvents() {
            // التنقل بين الصفحات
            $('.nav-link[data-page]').click(function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                
                const page = $(this).data('page');
                showPage(page);
            });
            
            // تسجيل الخروج
            $('#logoutBtn').click(function() {
                if (confirm('هل تريد تسجيل الخروج؟')) {
                    localStorage.removeItem('currentUser');
                    location.reload();
                }
            });
            
            // البحث
            $('#searchBtn').click(function() {
                performSearch();
            });
            
            $('#mainSearchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    performSearch();
                }
            });
            
            // البحث المتقدم
            $('#executeAdvancedSearch').click(function() {
                performAdvancedSearch();
            });
            
            // تحديث البيانات
            $('#refreshBtn').click(function() {
                refreshData();
            });
            
            // تصدير البيانات
            $('#exportBtn').click(function() {
                exportData();
            });
            
            // طلب جديد
            $('#newRequestBtn, #floatingAddBtn').click(function() {
                openNewRequestModal();
            });
        }

        function showPage(page) {
            $('.page-section').removeClass('active');
            $(`#${page}Section`).addClass('active');
        }

        function performSearch() {
            const searchTerm = $('#mainSearchInput').val().toLowerCase();
            const searchType = $('#searchType').val();
            
            filteredRequests = allRequests.filter(request => {
                if (!searchTerm) return true;
                
                if (searchType === 'both' || searchType === 'nationalId') {
                    if (request.nationalId.includes(searchTerm)) return true;
                }
                
                if (searchType === 'both' || searchType === 'name') {
                    if (request.applicantName.toLowerCase().includes(searchTerm)) return true;
                    if (request.requestTitle.toLowerCase().includes(searchTerm)) return true;
                }
                
                return false;
            });
            
            renderRequestsTable();
            
            if (filteredRequests.length === 0 && searchTerm) {
                $('#noResultsMessage').show();
            } else {
                $('#noResultsMessage').hide();
            }
        }

        function performAdvancedSearch() {
            const nationalId = $('#advNationalId').val();
            const applicantName = $('#advApplicantName').val();
            const category = $('#advCategory').val();
            const status = $('#advStatus').val();
            
            filteredRequests = allRequests.filter(request => {
                if (nationalId && !request.nationalId.includes(nationalId)) return false;
                if (applicantName && !request.applicantName.toLowerCase().includes(applicantName.toLowerCase())) return false;
                if (category && request.category !== category) return false;
                if (status && request.status !== status) return false;
                return true;
            });
            
            renderRequestsTable();
        }

        function renderRequestsTable() {
            const tbody = $('#requestsTableBody');
            tbody.empty();
            
            if (filteredRequests.length === 0) {
                $('#noResultsMessage').show();
                return;
            }
            
            $('#noResultsMessage').hide();
            
            filteredRequests.slice(0, 10).forEach((request, index) => {
                const category = categories[request.category];
                const status = statuses[request.status];
                
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${request.nationalId}</td>
                        <td>
                            <div class="fw-bold">${request.applicantName}</div>
                            <small class="text-muted">طلب #${request.id}</small>
                        </td>
                        <td>${request.requestTitle}</td>
                        <td>
                            <span class="category-badge ${getCategoryClass(request.category)}">
                                <i class="${category.icon} me-1"></i>${category.name}
                            </span>
                        </td>
                        <td>${formatDate(request.requestDate)}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(request.status)}">
                                <i class="${status.icon} me-1"></i>${status.name}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="showRequestDetails(${request.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-outline-success" onclick="updateRequestStatus(${request.id}, 'approved')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="editRequest(${request.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function renderCategoriesGrid() {
            const grid = $('#categoriesGrid');
            grid.empty();
            
            Object.entries(categories).forEach(([key, category]) => {
                const requestsCount = allRequests.filter(r => r.category === key).length;
                const pendingCount = allRequests.filter(r => r.category === key && r.status === 'pending').length;
                
                const card = `
                    <div class="col-md-6 col-lg-3">
                        <div class="card category-card h-100">
                            <div class="card-body">
                                <div class="d-flex align-items-center mb-3">
                                    <div class="stat-icon me-3" style="background-color: ${category.bgColor}; color: ${category.color};">
                                        <i class="${category.icon}"></i>
                                    </div>
                                    <div>
                                        <h6 class="mb-0">${category.name}</h6>
                                        <small class="text-muted">${category.description}</small>
                                    </div>
                                </div>
                                <div class="row text-center">
                                    <div class="col-6">
                                        <div class="h4 mb-0">${requestsCount}</div>
                                        <small>إجمالي</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="h4 mb-0">${pendingCount}</div>
                                        <small>انتظار</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                grid.append(card);
            });
        }

        function updateStatistics() {
            $('#totalRequests').text(allRequests.length);
            
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            const newRequests = allRequests.filter(r => new Date(r.requestDate) >= weekAgo).length;
            $('#newRequests').text(newRequests);
            
            const pendingRequests = allRequests.filter(r => r.status === 'pending').length;
            $('#pendingRequests').text(pendingRequests);
            
            const approvedRequests = allRequests.filter(r => r.status === 'approved').length;
            const completionRate = allRequests.length > 0 ? Math.round((approvedRequests / allRequests.length) * 100) : 0;
            $('#completionRate').text(completionRate + '%');
        }

        function openNewRequestModal() {
            const modalHtml = `
                <div class="modal fade" id="newRequestModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">طلب جديد</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="newRequestForm">
                                    <div class="mb-3">
                                        <label class="form-label">اسم مقدم الطلب</label>
                                        <input type="text" class="form-control" id="newApplicantName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">عنوان الطلب</label>
                                        <input type="text" class="form-control" id="newRequestTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">الهيئة الحكومية</label>
                                        <select class="form-select" id="newCategory" required>
                                            <option value="">اختر الهيئة</option>
                                            ${Object.entries(categories).map(([key, cat]) => 
                                                `<option value="${key}">${cat.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                                <button type="button" class="btn btn-primary" id="saveNewRequestBtn">حفظ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(modalHtml);
            $('#newRequestModal').modal('show');
            
            $('#saveNewRequestBtn').off('click').on('click', function() {
                saveNewRequest();
            });
            
            $('#newRequestModal').on('hidden.bs.modal', function() {
                $(this).remove();
            });
        }

        function saveNewRequest() {
            const newRequest = {
                id: allRequests.length ? Math.max(...allRequests.map(r => r.id)) + 1 : 1001,
                nationalId: '3' + Math.floor(Math.random() * 10000000000000).toString().padStart(13, '0'),
                applicantName: $('#newApplicantName').val(),
                requestTitle: $('#newRequestTitle').val(),
                requestSummary: 'طلب جديد',
                category: $('#newCategory').val(),
                status: 'submitted',
                requestDate: new Date().toISOString().split('T')[0],
                priority: 'medium',
                createdAt: new Date().toISOString(),
                createdBy: currentUser.username
            };
            
            allRequests.unshift(newRequest);
            localStorage.setItem('citizenRequests', JSON.stringify(allRequests));
            
            $('#newRequestModal').modal('hide');
            showNotification('تم إضافة الطلب بنجاح', 'success');
            
            refreshData();
            $(document).trigger('requestChanged');
        }

        function refreshData() {
            renderRequestsTable();
            updateStatistics();
            renderCategoriesGrid();
        }

        function exportData() {
            const dataStr = JSON.stringify(allRequests, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const link = document.createElement('a');
            link.setAttribute('href', dataUri);
            link.setAttribute('download', 'طلبات_المواطنين.json');
            link.click();
            
            showNotification('تم تصدير البيانات', 'success');
        }

        // وظائف مساعدة
        function getCategoryClass(category) {
            return `category-${category}`;
        }

        function getStatusClass(status) {
            return `status-${status}`;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }

        function showNotification(message, type) {
            const notification = `
                <div class="toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            $('body').append(notification);
            const toast = new bootstrap.Toast($('.toast').last()[0]);
            toast.show();
            
            setTimeout(() => $('.toast').last().remove(), 3000);
        }

        // تعريف الوظائف العامة
        window.showRequestDetails = function(id) {
            const request = allRequests.find(r => r.id === id);
            if (request) {
                const category = categories[request.category];
                const status = statuses[request.status];
                
                alert(`تفاصيل الطلب #${id}
الاسم: ${request.applicantName}
الرقم القومي: ${request.nationalId}
العنوان: ${request.requestTitle}
الهيئة: ${category.name}
الحالة: ${status.name}
التاريخ: ${formatDate(request.requestDate)}`);
            }
        };

        window.updateRequestStatus = function(id, newStatus) {
            const requestIndex = allRequests.findIndex(r => r.id === id);
            if (requestIndex !== -1) {
                allRequests[requestIndex].status = newStatus;
                localStorage.setItem('citizenRequests', JSON.stringify(allRequests));
                
                refreshData();
                $(document).trigger('requestChanged');
                showNotification(`تم تحديث حالة الطلب إلى ${statuses[newStatus].name}`, 'success');
            }
        };

        window.editRequest = function(id) {
            showRequestDetails(id);
        };

        window.syncToGist = function() {
            syncToGist(true);
        };

        window.syncFromGist = syncFromGist;
    </script>
</body>
</html>
