<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="theme-color" content="#1e3a8a">
    <title>نظام متابعة طلبات المواطنين - عضو مجلس النواب</title>
    
    <!-- PWA Meta Tags -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi2KfZhNin2KrYsdio2YQg2KfZhNij2YXZhNmFINin2YTYp9iq2LHZiNipIiwiZGVzY3JpcHRpb24iOiLYp9mE2KfYqtix2KjZhCDYp9mE2KfYqtix2YjYqSDZhNi52KfYjCDYp9mE2KfYqtix2YjYqSIsInRhZ3MiOiJnb3Zlcm5tZW50IiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiIzFlM2E4YSIsInRoZW1lX2NvbG9yIjoiIzFlM2E4YSIsInN0YXJ0X3VybCI6Ii8iLCJpY29ucyI6W3sic3JjIjoiaWNvbnMvaWNvbi03Mng3Mi5wbmciLCJzaXplcyI6IjcyeDcyIiwidHlwZSI6ImltYWdlL3BuZyJ9XX0=">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="طلبات المواطنين">
    
    <!-- Bootstrap & Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        /* تصميم Mobile-First */
        :root {
            --primary: #1e3a8a;
            --secondary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #0ea5e9;
            --electricity: #f97316;
            --health: #ec4899;
            --water: #0ea5e9;
            --sanitation: #8b5cf6;
            --education: #84cc16;
            --transport: #6366f1;
        }
        
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            padding-bottom: 80px;
            padding-top: env(safe-area-inset-top);
            padding-left: env(safe-area-inset-left);
            padding-right: env(safe-area-inset-right);
        }
        
        /* شريط العنوان للجوال */
        .mobile-header {
            background: white;
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            padding: 15px;
            position: sticky;
            top: 0;
            z-index: 1000;
            margin: -8px -8px 15px -8px;
        }
        
        /* عرض الطلبات للجوال */
        .mobile-request-card {
            background: white;
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.08);
            border-right: 4px solid;
            transition: transform 0.2s;
        }
        
        .mobile-request-card:hover {
            transform: translateY(-2px);
        }
        
        /* أزرار الإجراءات السريعة */
        .quick-actions {
            position: fixed;
            bottom: max(20px, env(safe-area-inset-bottom));
            left: max(15px, env(safe-area-inset-left));
            right: max(15px, env(safe-area-inset-right));
            background: white;
            padding: 12px;
            border-radius: 20px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .quick-actions .btn {
            flex: 1;
            padding: 12px;
            border-radius: 15px;
            font-weight: 600;
        }
        
        /* حالات الطلبات */
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-submitted { background: #dbeafe; color: var(--primary); }
        .status-pending { background: #fef3c7; color: var(--warning); }
        .status-inprogress { background: #e0f2fe; color: var(--info); }
        .status-approved { background: #d1fae5; color: var(--success); }
        .status-rejected { background: #fee2e2; color: var(--danger); }
        
        /* فئات الهيئات الحكومية */
        .category-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .category-electricity { background: #ffedd5; color: var(--electricity); border-left: 4px solid var(--electricity); }
        .category-health { background: #fce7f3; color: var(--health); border-left: 4px solid var(--health); }
        .category-water { background: #e0f2fe; color: var(--water); border-left: 4px solid var(--water); }
        .category-sanitation { background: #f3e8ff; color: var(--sanitation); border-left: 4px solid var(--sanitation); }
        .category-education { background: #f0fdf4; color: var(--education); border-left: 4px solid var(--education); }
        .category-transport { background: #eef2ff; color: var(--transport); border-left: 4px solid var(--transport); }
        
        /* إحصائيات سريعة */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        /* فلتر الحالات */
        .status-filter {
            display: flex;
            overflow-x: auto;
            gap: 8px;
            padding: 10px 0;
            margin-bottom: 15px;
            -webkit-overflow-scrolling: touch;
        }
        
        .status-filter::-webkit-scrollbar {
            display: none;
        }
        
        .status-filter-btn {
            padding: 8px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            background: white;
            white-space: nowrap;
            font-size: 0.9rem;
        }
        
        .status-filter-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* تحسينات النماذج */
        .form-control, .form-select {
            padding: 12px 15px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
            font-size: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1);
        }
        
        /* أزرار تغيير الحالة */
        .status-change-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 20px;
        }
        
        .status-btn {
            padding: 12px;
            border-radius: 12px;
            border: none;
            color: white;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        /* البحث المحسن */
        .search-container {
            position: relative;
            margin-bottom: 15px;
        }
        
        .search-input {
            width: 100%;
            padding: 14px 45px 14px 14px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            background: white;
        }
        
        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
        }
        
        /* تحسينات للشاشات الكبيرة */
        @media (min-width: 768px) {
            body {
                padding: 20px;
            }
            
            .mobile-header {
                display: none;
            }
            
            .quick-actions {
                display: none;
            }
            
            .container {
                max-width: 1200px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        /* تحميل وهمي */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* إشعارات */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            min-width: 300px;
            max-width: 90%;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }
        
        /* تحسينات للجدول على الشاشات الكبيرة */
        @media (min-width: 768px) {
            .table-responsive {
                border-radius: 15px;
                overflow: hidden;
            }
            
            .table th {
                background: #f8f9fa;
                font-weight: 600;
                padding: 15px;
            }
            
            .table td {
                padding: 12px 15px;
                vertical-align: middle;
            }
        }
    </style>
</head>
<body>
    <!-- شريط العنوان للجوال -->
    <div class="mobile-header d-md-none">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h5 class="mb-1"><i class="fas fa-hands-helping me-2"></i>طلبات المواطنين</h5>
                <small class="text-muted">عضو مجلس النواب</small>
            </div>
            <button class="btn btn-sm btn-outline-primary" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </div>

    <!-- قائمة الجوال -->
    <div class="offcanvas offcanvas-end" id="mobileMenu">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title">القائمة</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
        </div>
        <div class="offcanvas-body">
            <div class="list-group list-group-flush">
                <button class="list-group-item list-group-item-action" onclick="showPage('dashboard')">
                    <i class="fas fa-home me-3"></i>لوحة التحكم
                </button>
                <button class="list-group-item list-group-item-action" onclick="showPage('requests')">
                    <i class="fas fa-list me-3"></i>جميع الطلبات
                </button>
                <button class="list-group-item list-group-item-action" onclick="showPage('search')">
                    <i class="fas fa-search me-3"></i>بحث متقدم
                </button>
                <button class="list-group-item list-group-item-action" onclick="showPage('categories')">
                    <i class="fas fa-layer-group me-3"></i>الهيئات الحكومية
                </button>
                <button class="list-group-item list-group-item-action" onclick="showPage('statistics')">
                    <i class="fas fa-chart-bar me-3"></i>الإحصائيات
                </button>
                <button class="list-group-item list-group-item-action" onclick="exportData()">
                    <i class="fas fa-download me-3"></i>تصدير البيانات
                </button>
                <button class="list-group-item list-group-item-action text-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt me-3"></i>تسجيل الخروج
                </button>
            </div>
        </div>
    </div>

    <!-- المحتوى الرئيسي -->
    <main class="container">
        <!-- صفحة لوحة التحكم -->
        <div id="dashboardPage" class="page">
            <!-- شريط البحث -->
            <div class="search-container">
                <input type="text" class="search-input" id="mainSearch" 
                       placeholder="ابحث بالرقم القومي أو اسم مقدم الطلب...">
                <i class="fas fa-search search-icon"></i>
            </div>
            
            <!-- فلتر الحالات -->
            <div class="status-filter">
                <button class="status-filter-btn active" data-status="all">الكل</button>
                <button class="status-filter-btn" data-status="submitted">تم التقديم</button>
                <button class="status-filter-btn" data-status="pending">قيد الانتظار</button>
                <button class="status-filter-btn" data-status="inprogress">قيد التنفيذ</button>
                <button class="status-filter-btn" data-status="approved">موافق</button>
                <button class="status-filter-btn" data-status="rejected">غير موافق</button>
            </div>
            
            <!-- الإحصائيات -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalStat">0</div>
                    <div class="stat-label">إجمالي الطلبات</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="newStat">0</div>
                    <div class="stat-label">طلبات جديدة</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="pendingStat">0</div>
                    <div class="stat-label">قيد الانتظار</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="approvedStat">0</div>
                    <div class="stat-label">تم الموافقة</div>
                </div>
            </div>
            
            <!-- الطلبات الأخيرة -->
            <h5 class="mb-3"><i class="fas fa-clock me-2"></i>الطلبات الأخيرة</h5>
            <div id="recentRequests"></div>
        </div>
        
        <!-- صفحة جميع الطلبات -->
        <div id="requestsPage" class="page d-none">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-list me-2"></i>جميع الطلبات</h5>
                <button class="btn btn-primary btn-sm" onclick="showNewRequestModal()">
                    <i class="fas fa-plus me-1"></i>جديد
                </button>
            </div>
            
            <!-- جدول الطلبات للشاشات الكبيرة -->
            <div class="d-none d-md-block">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>الرقم القومي</th>
                                <th>الاسم</th>
                                <th>العنوان</th>
                                <th>الفئة</th>
                                <th>التاريخ</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="desktopRequestsTable">
                            <!-- سيتم تعبئتها -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- عرض الطلبات للجوال -->
            <div class="d-md-none" id="mobileRequestsList">
                <!-- سيتم تعبئتها -->
            </div>
        </div>
        
        <!-- صفحة البحث المتقدم -->
        <div id="searchPage" class="page d-none">
            <h5 class="mb-4"><i class="fas fa-search me-2"></i>بحث متقدم</h5>
            
            <div class="card mb-3">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">نوع البحث</label>
                            <select class="form-select" id="searchType">
                                <option value="all">بحث شامل</option>
                                <option value="nationalId">رقم قومي فقط</option>
                                <option value="name">اسم فقط</option>
                                <option value="title">عنوان فقط</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">الهيئة الحكومية</label>
                            <select class="form-select" id="searchCategory">
                                <option value="">جميع الهيئات</option>
                                <option value="electricity">كهرباء</option>
                                <option value="health">صحة</option>
                                <option value="water">مياه</option>
                                <option value="sanitation">صرف صحي</option>
                                <option value="education">تعليم</option>
                                <option value="transport">مواصلات</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">الفترة الزمنية</label>
                            <select class="form-select" id="searchDate">
                                <option value="">جميع الفترات</option>
                                <option value="today">اليوم</option>
                                <option value="week">آخر أسبوع</option>
                                <option value="month">آخر شهر</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">حالة الطلب</label>
                            <select class="form-select" id="searchStatus">
                                <option value="">جميع الحالات</option>
                                <option value="submitted">تم التقديم</option>
                                <option value="pending">قيد الانتظار</option>
                                <option value="inprogress">قيد التنفيذ</option>
                                <option value="approved">موافق</option>
                                <option value="rejected">غير موافق</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary w-100" onclick="performAdvancedSearch()">
                            <i class="fas fa-search me-2"></i>بحث
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="searchResults"></div>
        </div>
        
        <!-- صفحة الهيئات الحكومية -->
        <div id="categoriesPage" class="page d-none">
            <h5 class="mb-4"><i class="fas fa-layer-group me-2"></i>الهيئات الحكومية</h5>
            
            <div class="row g-3">
                <div class="col-md-6 col-lg-4">
                    <div class="card category-electricity">
                        <div class="card-body">
                            <h6><i class="fas fa-bolt me-2"></i>كهرباء</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <span>عدد الطلبات:</span>
                                <strong id="electricityCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="card category-health">
                        <div class="card-body">
                            <h6><i class="fas fa-hospital me-2"></i>صحة</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <span>عدد الطلبات:</span>
                                <strong id="healthCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="card category-water">
                        <div class="card-body">
                            <h6><i class="fas fa-tint me-2"></i>مياه</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <span>عدد الطلبات:</span>
                                <strong id="waterCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="card category-sanitation">
                        <div class="card-body">
                            <h6><i class="fas fa-toilet me-2"></i>صرف صحي</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <span>عدد الطلبات:</span>
                                <strong id="sanitationCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="card category-education">
                        <div class="card-body">
                            <h6><i class="fas fa-graduation-cap me-2"></i>تعليم</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <span>عدد الطلبات:</span>
                                <strong id="educationCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 col-lg-4">
                    <div class="card category-transport">
                        <div class="card-body">
                            <h6><i class="fas fa-bus me-2"></i>مواصلات</h6>
                            <div class="d-flex justify-content-between mt-3">
                                <span>عدد الطلبات:</span>
                                <strong id="transportCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- صفحة الإحصائيات -->
        <div id="statisticsPage" class="page d-none">
            <h5 class="mb-4"><i class="fas fa-chart-bar me-2"></i>الإحصائيات</h5>
            
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h6>توزيع الطلبات حسب الحالة</h6>
                            <canvas id="statusChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card">
                        <div class="card-body">
                            <h6>توزيع الطلبات حسب الهيئات</h6>
                            <canvas id="categoryChart" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h6>طلبات تحتاج متابعة عاجلة</h6>
                    <div id="urgentRequests"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- أزرار الإجراءات السريعة للجوال -->
    <div class="quick-actions d-md-none">
        <button class="btn btn-primary" onclick="showNewRequestModal()">
            <i class="fas fa-plus me-1"></i>جديد
        </button>
        <button class="btn btn-outline-primary" onclick="refreshData()">
            <i class="fas fa-redo"></i>
        </button>
        <button class="btn btn-outline-primary" onclick="showPage('search')">
            <i class="fas fa-search"></i>
        </button>
    </div>

    <!-- نافذة إضافة طلب جديد -->
    <div class="modal fade" id="newRequestModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>طلب جديد</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="requestForm">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">الرقم القومي *</label>
                                <input type="text" class="form-control" id="nationalId" 
                                       maxlength="14" pattern="\d{14}" required>
                                <div class="form-text">14 رقمًا</div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">اسم مقدم الطلب *</label>
                                <input type="text" class="form-control" id="applicantName" required>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label fw-bold">عنوان الطلب *</label>
                                <input type="text" class="form-control" id="requestTitle" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-bold">الهيئة الحكومية *</label>
                                <select class="form-select" id="requestCategory" required>
                                    <option value="">اختر الهيئة</option>
                                    <option value="electricity">كهرباء</option>
                                    <option value="health">صحة</option>
                                    <option value="water">مياه</option>
                                    <option value="sanitation">صرف صحي</option>
                                    <option value="education">تعليم</option>
                                    <option value="transport">مواصلات</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-bold">نظرة عن الطلب *</label>
                                <textarea class="form-control" id="requestSummary" rows="4" required></textarea>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">ملف PDF (اختياري)</label>
                                <input type="file" class="form-control" id="requestFile" accept=".pdf">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">تاريخ التقديم</label>
                                <input type="date" class="form-control" id="requestDate">
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            سيتم إرسال إشعار صوتي عند إضافة الطلب الجديد
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" onclick="submitNewRequest()">
                        <i class="fas fa-save me-2"></i>حفظ الطلب
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تفاصيل الطلب -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تفاصيل الطلب</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="requestDetailsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تغيير الحالة -->
    <div class="modal fade" id="statusModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">تغيير حالة الطلب</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="status-change-buttons" id="statusButtons">
                        <button class="status-btn" style="background: var(--primary);" onclick="changeStatus('submitted')">
                            <i class="fas fa-file-import"></i> تم التقديم
                        </button>
                        <button class="status-btn" style="background: var(--warning);" onclick="changeStatus('pending')">
                            <i class="fas fa-clock"></i> قيد الانتظار
                        </button>
                        <button class="status-btn" style="background: var(--info);" onclick="changeStatus('inprogress')">
                            <i class="fas fa-spinner"></i> قيد التنفيذ
                        </button>
                        <button class="status-btn" style="background: var(--success);" onclick="changeStatus('approved')">
                            <i class="fas fa-check"></i> موافق
                        </button>
                        <button class="status-btn" style="background: var(--danger);" onclick="showCommentField()">
                            <i class="fas fa-times"></i> غير موافق
                        </button>
                    </div>
                    
                    <div class="mt-3 d-none" id="commentField">
                        <label class="form-label">سبب الرفض أو التعليق</label>
                        <textarea class="form-control" id="statusComment" rows="3"></textarea>
                        <button class="btn btn-primary w-100 mt-2" onclick="submitRejection()">
                            حفظ مع التعليق
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- التطبيق الرئيسي -->
    <script>
        // تعريف البيانات
        const categories = {
            electricity: { name: 'كهرباء', color: '#f97316', icon: 'fa-bolt' },
            health: { name: 'صحة', color: '#ec4899', icon: 'fa-hospital' },
            water: { name: 'مياه', color: '#0ea5e9', icon: 'fa-tint' },
            sanitation: { name: 'صرف صحي', color: '#8b5cf6', icon: 'fa-toilet' },
            education: { name: 'تعليم', color: '#84cc16', icon: 'fa-graduation-cap' },
            transport: { name: 'مواصلات', color: '#6366f1', icon: 'fa-bus' }
        };

        const statuses = {
            submitted: { name: 'تم التقديم', color: '#3b82f6', icon: 'fa-file-import' },
            pending: { name: 'قيد الانتظار', color: '#f59e0b', icon: 'fa-clock' },
            inprogress: { name: 'قيد التنفيذ', color: '#0ea5e9', icon: 'fa-spinner' },
            approved: { name: 'موافق', color: '#10b981', icon: 'fa-check' },
            rejected: { name: 'غير موافق', color: '#ef4444', icon: 'fa-times' }
        };

        // بيانات التطبيق
        let allRequests = JSON.parse(localStorage.getItem('citizenRequests')) || [
            {
                id: 1001,
                nationalId: "29801011234567",
                applicantName: "أحمد محمد علي",
                requestTitle: "طلب توصيل خدمة كهرباء",
                requestSummary: "توصيل خدمة الكهرباء للمنطقة السكنية الجديدة",
                category: "electricity",
                status: "pending",
                date: "2024-01-15",
                priority: "high",
                file: null,
                comments: "",
                createdAt: new Date().toISOString()
            },
            {
                id: 1002,
                nationalId: "29905052345678",
                applicantName: "سارة خالد حسن",
                requestTitle: "طلب إنشاء مركز صحي",
                requestSummary: "الحاجة لمركز صحي في الحي الجديد",
                category: "health",
                status: "approved",
                date: "2024-01-10",
                priority: "medium",
                file: null,
                comments: "تمت الموافقة على الطلب",
                createdAt: new Date().toISOString()
            }
        ];

        // حالة التطبيق
        let currentPage = 'dashboard';
        let currentFilter = 'all';
        let searchTerm = '';
        let selectedRequestId = null;
        let charts = {};

        // تهيئة التطبيق
        $(document).ready(function() {
            initializeApp();
        });

        // تهيئة التطبيق
        function initializeApp() {
            // حفظ البيانات إن لم تكن موجودة
            saveData();
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
            
            // تحميل البيانات
            loadDashboard();
            
            // تسجيل Service Worker
            registerServiceWorker();
            
            // عرض رسالة ترحيب
            setTimeout(showWelcome, 1000);
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // البحث
            $('#mainSearch').on('input', debounce(function() {
                searchTerm = $(this).val();
                filterRequests();
            }, 300));

            // فلتر الحالات
            $('.status-filter-btn').click(function() {
                $('.status-filter-btn').removeClass('active');
                $(this).addClass('active');
                currentFilter = $(this).data('status');
                filterRequests();
            });

            // تفعيل PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', function() {
                    navigator.serviceWorker.register('/service-worker.js');
                });
            }

            // منع إعادة تحميل الصفحة
            window.addEventListener('beforeunload', function(e) {
                saveData();
            });
        }

        // تحميل لوحة التحكم
        function loadDashboard() {
            updateStatistics();
            loadRecentRequests();
            updateCategoryCounts();
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            const total = allRequests.length;
            const newRequests = allRequests.filter(r => {
                const requestDate = new Date(r.date);
                const today = new Date();
                const diffTime = today - requestDate;
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return diffDays <= 7;
            }).length;
            
            const pending = allRequests.filter(r => r.status === 'pending').length;
            const approved = allRequests.filter(r => r.status === 'approved').length;

            $('#totalStat').text(total);
            $('#newStat').text(newRequests);
            $('#pendingStat').text(pending);
            $('#approvedStat').text(approved);
        }

        // تحميل الطلبات الأخيرة
        function loadRecentRequests() {
            const recent = allRequests.slice(0, 5);
            const container = $('#recentRequests');
            container.empty();

            if (recent.length === 0) {
                container.html(`
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">لا توجد طلبات</p>
                    </div>
                `);
                return;
            }

            recent.forEach(request => {
                const status = statuses[request.status];
                const category = categories[request.category];
                
                const card = `
                    <div class="mobile-request-card" style="border-right-color: ${status.color}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${request.requestTitle}</h6>
                                <p class="text-muted small mb-1">${request.applicantName}</p>
                            </div>
                            <span class="status-badge status-${request.status}">
                                ${status.name}
                            </span>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span class="category-badge category-${request.category}">
                                    <i class="fas ${category.icon} me-1"></i>${category.name}
                                </span>
                                <small class="text-muted ms-2">${formatDate(request.date)}</small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-1" onclick="showRequestDetails(${request.id})">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-warning" onclick="changeRequestStatus(${request.id})">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                container.append(card);
            });
        }

        // فلترة الطلبات
        function filterRequests() {
            let filtered = [...allRequests];
            
            // فلتر البحث
            if (searchTerm.trim() !== '') {
                const query = searchTerm.toLowerCase();
                filtered = filtered.filter(request => 
                    request.nationalId.includes(query) ||
                    request.applicantName.toLowerCase().includes(query) ||
                    request.requestTitle.toLowerCase().includes(query)
                );
            }
            
            // فلتر الحالة
            if (currentFilter !== 'all') {
                filtered = filtered.filter(request => request.status === currentFilter);
            }
            
            // تحديث العرض
            updateRequestDisplay(filtered);
        }

        // تحديث عرض الطلبات
        function updateRequestDisplay(filtered) {
            // تحديث العداد
            $('#totalStat').text(filtered.length);
            
            // عرض للجوال
            const mobileContainer = $('#mobileRequestsList');
            mobileContainer.empty();
            
            // عرض للشاشات الكبيرة
            const desktopTable = $('#desktopRequestsTable');
            desktopTable.empty();
            
            if (filtered.length === 0) {
                mobileContainer.html(`
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">لا توجد نتائج</p>
                    </div>
                `);
                return;
            }
            
            filtered.forEach(request => {
                const status = statuses[request.status];
                const category = categories[request.category];
                
                // بطاقة الجوال
                const mobileCard = `
                    <div class="mobile-request-card" style="border-right-color: ${status.color}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${request.requestTitle}</h6>
                                <p class="text-muted small mb-1">${request.applicantName}</p>
                            </div>
                            <span class="status-badge status-${request.status}">
                                ${status.name}
                            </span>
                        </div>
                        
                        <div class="row small text-muted mb-2">
                            <div class="col-6">
                                <i class="fas fa-id-card me-1"></i>${request.nationalId}
                            </div>
                            <div class="col-6 text-start">
                                <i class="fas fa-calendar me-1"></i>${formatDate(request.date)}
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between">
                            <button class="btn btn-sm btn-outline-primary" onclick="showRequestDetails(${request.id})">
                                <i class="fas fa-eye me-1"></i>عرض
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="changeRequestStatus(${request.id})">
                                <i class="fas fa-edit me-1"></i>تغيير الحالة
                            </button>
                        </div>
                    </div>
                `;
                
                mobileContainer.append(mobileCard);
                
                // صف الشاشات الكبيرة
                const desktopRow = `
                    <tr>
                        <td>${request.id}</td>
                        <td>${request.nationalId}</td>
                        <td>${request.applicantName}</td>
                        <td>${request.requestTitle}</td>
                        <td>
                            <span class="category-badge category-${request.category}">
                                <i class="fas ${category.icon} me-1"></i>${category.name}
                            </span>
                        </td>
                        <td>${formatDate(request.date)}</td>
                        <td>
                            <span class="status-badge status-${request.status}">
                                ${status.name}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="showRequestDetails(${request.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-warning me-1" onclick="changeRequestStatus(${request.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteRequest(${request.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                
                desktopTable.append(desktopRow);
            });
        }

        // عرض صفحة معينة
        function showPage(pageName) {
            // إخفاء جميع الصفحات
            $('.page').addClass('d-none');
            
            // إظهار الصفحة المطلوبة
            $(`#${pageName}Page`).removeClass('d-none');
            
            // تحديث الصفحة الحالية
            currentPage = pageName;
            
            // تحميل بيانات الصفحة
            switch(pageName) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'requests':
                    filterRequests();
                    break;
                case 'statistics':
                    loadStatistics();
                    break;
                case 'categories':
                    updateCategoryCounts();
                    break;
            }
            
            // إغلاق قائمة الجوال
            if (window.innerWidth < 768) {
                bootstrap.Offcanvas.getInstance(document.getElementById('mobileMenu')).hide();
            }
        }

        // تحديث أعداد الفئات
        function updateCategoryCounts() {
            Object.keys(categories).forEach(category => {
                const count = allRequests.filter(r => r.category === category).length;
                $(`#${category}Count`).text(count);
            });
        }

        // تحميل الإحصائيات
        function loadStatistics() {
            // توزيع الحالات
            const statusData = {
                submitted: allRequests.filter(r => r.status === 'submitted').length,
                pending: allRequests.filter(r => r.status === 'pending').length,
                inprogress: allRequests.filter(r => r.status === 'inprogress').length,
                approved: allRequests.filter(r => r.status === 'approved').length,
                rejected: allRequests.filter(r => r.status === 'rejected').length
            };

            // توزيع الفئات
            const categoryData = {};
            Object.keys(categories).forEach(category => {
                categoryData[category] = allRequests.filter(r => r.category === category).length;
            });

            // رسم المخططات
            drawStatusChart(statusData);
            drawCategoryChart(categoryData);
            loadUrgentRequests();
        }

        // رسم مخطط الحالات
        function drawStatusChart(data) {
            const ctx = document.getElementById('statusChart');
            if (!ctx) return;

            if (charts.statusChart) {
                charts.statusChart.destroy();
            }

            charts.statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['تم التقديم', 'قيد الانتظار', 'قيد التنفيذ', 'موافق', 'غير موافق'],
                    datasets: [{
                        data: [data.submitted, data.pending, data.inprogress, data.approved, data.rejected],
                        backgroundColor: [
                            '#3b82f6',
                            '#f59e0b',
                            '#0ea5e9',
                            '#10b981',
                            '#ef4444'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true
                        }
                    }
                }
            });
        }

        // رسم مخطط الفئات
        function drawCategoryChart(data) {
            const ctx = document.getElementById('categoryChart');
            if (!ctx) return;

            if (charts.categoryChart) {
                charts.categoryChart.destroy();
            }

            charts.categoryChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.values(categories).map(c => c.name),
                    datasets: [{
                        data: Object.values(data),
                        backgroundColor: Object.values(categories).map(c => c.color)
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true
                        }
                    }
                }
            });
        }

        // تحميل الطلبات العاجلة
        function loadUrgentRequests() {
            const urgent = allRequests.filter(r => 
                r.status === 'pending' || r.status === 'inprogress'
            ).slice(0, 5);
            
            const container = $('#urgentRequests');
            container.empty();
            
            if (urgent.length === 0) {
                container.html('<p class="text-muted">لا توجد طلبات عاجلة</p>');
                return;
            }
            
            urgent.forEach(request => {
                const status = statuses[request.status];
                const category = categories[request.category];
                
                const item = `
                    <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                        <div>
                            <h6 class="mb-1">${request.requestTitle}</h6>
                            <small class="text-muted">${request.applicantName}</small>
                        </div>
                        <div class="text-start">
                            <span class="badge" style="background: ${status.color}; color: white;">
                                ${status.name}
                            </span>
                            <button class="btn btn-sm btn-outline-primary mt-1" onclick="showRequestDetails(${request.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                container.append(item);
            });
        }

        // إظهار نافذة طلب جديد
        function showNewRequestModal() {
            // تنظيف النموذج
            $('#requestForm')[0].reset();
            
            // تعيين التاريخ الحالي
            const today = new Date().toISOString().split('T')[0];
            $('#requestDate').val(today);
            
            // إظهار النافذة
            new bootstrap.Modal(document.getElementById('newRequestModal')).show();
        }

        // إرسال طلب جديد
        function submitNewRequest() {
            // التحقق من البيانات
            if (!validateRequestForm()) {
                return;
            }

            // إنشاء طلب جديد
            const newId = allRequests.length > 0 ? Math.max(...allRequests.map(r => r.id)) + 1 : 1001;
            
            const newRequest = {
                id: newId,
                nationalId: $('#nationalId').val(),
                applicantName: $('#applicantName').val(),
                requestTitle: $('#requestTitle').val(),
                requestSummary: $('#requestSummary').val(),
                category: $('#requestCategory').val(),
                status: 'submitted',
                date: $('#requestDate').val() || new Date().toISOString().split('T')[0],
                priority: 'medium',
                file: null,
                comments: '',
                createdAt: new Date().toISOString()
            };

            // إضافة الطلب
            allRequests.unshift(newRequest);
            saveData();
            
            // إغلاق النافذة
            bootstrap.Modal.getInstance(document.getElementById('newRequestModal')).hide();
            
            // تحديث العرض
            loadDashboard();
            filterRequests();
            
            // إشعار صوتي
            playNotificationSound();
            
            // إشعار مرئي
            showNotification(`تم إضافة طلب جديد #${newId}`, 'success');
            
            // اهتزاز على الجوال
            if (navigator.vibrate) {
                navigator.vibrate(100);
            }
        }

        // التحقق من نموذج الطلب
        function validateRequestForm() {
            const nationalId = $('#nationalId').val();
            const applicantName = $('#applicantName').val();
            const requestTitle = $('#requestTitle').val();
            const requestSummary = $('#requestSummary').val();
            const requestCategory = $('#requestCategory').val();

            if (!nationalId || nationalId.length !== 14 || !/^\d+$/.test(nationalId)) {
                showNotification('الرجاء إدخال رقم قومي صحيح (14 رقمًا)', 'error');
                return false;
            }

            if (!applicantName.trim()) {
                showNotification('الرجاء إدخال اسم مقدم الطلب', 'error');
                return false;
            }

            if (!requestTitle.trim()) {
                showNotification('الرجاء إدخال عنوان الطلب', 'error');
                return false;
            }

            if (!requestCategory) {
                showNotification('الرجاء اختيار الهيئة الحكومية', 'error');
                return false;
            }

            if (!requestSummary.trim()) {
                showNotification('الرجاء إدخال نظرة عن الطلب', 'error');
                return false;
            }

            return true;
        }

        // عرض تفاصيل الطلب
        function showRequestDetails(requestId) {
            const request = allRequests.find(r => r.id === requestId);
            if (!request) return;
            
            const status = statuses[request.status];
            const category = categories[request.category];
            
            const detailsHtml = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h6>رقم الطلب:</h6>
                        <p class="fw-bold">#${request.id}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>الحالة:</h6>
                        <p>
                            <span class="status-badge status-${request.status}">
                                ${status.name}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>الرقم القومي:</h6>
                        <p>${request.nationalId}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>اسم مقدم الطلب:</h6>
                        <p>${request.applicantName}</p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>الهيئة الحكومية:</h6>
                        <p>
                            <span class="category-badge category-${request.category}">
                                <i class="fas ${category.icon} me-1"></i>${category.name}
                            </span>
                        </p>
                    </div>
                    <div class="col-md-6 mb-3">
                        <h6>تاريخ التقديم:</h6>
                        <p>${formatDate(request.date)}</p>
                    </div>
                    <div class="col-12 mb-3">
                        <h6>عنوان الطلب:</h6>
                        <p>${request.requestTitle}</p>
                    </div>
                    <div class="col-12 mb-3">
                        <h6>نظرة عن الطلب:</h6>
                        <p>${request.requestSummary}</p>
                    </div>
                    ${request.comments ? `
                    <div class="col-12 mb-3">
                        <h6>التعليقات:</h6>
                        <div class="alert alert-warning">
                            ${request.comments}
                        </div>
                    </div>
                    ` : ''}
                </div>
                
                <div class="mt-4">
                    <button class="btn btn-primary w-100" onclick="changeRequestStatus(${request.id})">
                        <i class="fas fa-edit me-2"></i>تغيير حالة الطلب
                    </button>
                </div>
            `;
            
            $('#requestDetailsContent').html(detailsHtml);
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        }

        // تغيير حالة الطلب
        function changeRequestStatus(requestId) {
            selectedRequestId = requestId;
            $('#commentField').addClass('d-none');
            new bootstrap.Modal(document.getElementById('statusModal')).show();
        }

        // إظهار حقل التعليق للرفض
        function showCommentField() {
            $('#commentField').removeClass('d-none');
        }

        // رفض الطلب مع تعليق
        function submitRejection() {
            const comment = $('#statusComment').val();
            if (!comment.trim()) {
                showNotification('الرجاء إدخال سبب الرفض', 'error');
                return;
            }
            
            updateRequestStatus('rejected', comment);
            $('#commentField').addClass('d-none');
            $('#statusComment').val('');
        }

        // تغيير حالة الطلب
        function changeStatus(newStatus) {
            updateRequestStatus(newStatus);
        }

        // تحديث حالة الطلب
        function updateRequestStatus(newStatus, comment = '') {
            const requestIndex = allRequests.findIndex(r => r.id === selectedRequestId);
            if (requestIndex === -1) return;
            
            const oldStatus = allRequests[requestIndex].status;
            allRequests[requestIndex].status = newStatus;
            
            if (comment) {
                allRequests[requestIndex].comments = comment;
            }
            
            allRequests[requestIndex].updatedAt = new Date().toISOString();
            saveData();
            
            // إغلاق النوافذ
            bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
            bootstrap.Modal.getInstance(document.getElementById('detailsModal')).hide();
            
            // تحديث العرض
            loadDashboard();
            filterRequests();
            
            // إشعار
            showNotification(`تم تغيير حالة الطلب إلى "${statuses[newStatus].name}"`, 'success');
            
            // تسجيل النشاط
            logActivity(selectedRequestId, oldStatus, newStatus, comment);
        }

        // حذف الطلب
        function deleteRequest(requestId) {
            if (!confirm('هل أنت متأكد من حذف هذا الطلب؟')) {
                return;
            }
            
            const requestIndex = allRequests.findIndex(r => r.id === requestId);
            if (requestIndex === -1) return;
            
            allRequests.splice(requestIndex, 1);
            saveData();
            
            // تحديث العرض
            loadDashboard();
            filterRequests();
            
            showNotification('تم حذف الطلب بنجاح', 'success');
        }

        // بحث متقدم
        function performAdvancedSearch() {
            const searchType = $('#searchType').val();
            const category = $('#searchCategory').val();
            const dateFilter = $('#searchDate').val();
            const status = $('#searchStatus').val();
            
            let filtered = [...allRequests];
            
            // فلتر الفئة
            if (category) {
                filtered = filtered.filter(r => r.category === category);
            }
            
            // فلتر التاريخ
            if (dateFilter) {
                const today = new Date();
                filtered = filtered.filter(r => {
                    const requestDate = new Date(r.date);
                    const diffTime = today - requestDate;
                    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                    
                    switch(dateFilter) {
                        case 'today': return diffDays === 0;
                        case 'week': return diffDays <= 7;
                        case 'month': return diffDays <= 30;
                        default: return true;
                    }
                });
            }
            
            // فلتر الحالة
            if (status) {
                filtered = filtered.filter(r => r.status === status);
            }
            
            // عرض النتائج
            const container = $('#searchResults');
            container.empty();
            
            if (filtered.length === 0) {
                container.html(`
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <p class="text-muted">لا توجد نتائج</p>
                    </div>
                `);
                return;
            }
            
            filtered.forEach(request => {
                const status = statuses[request.status];
                const category = categories[request.category];
                
                const card = `
                    <div class="mobile-request-card mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${request.requestTitle}</h6>
                                <p class="text-muted small mb-1">${request.applicantName}</p>
                            </div>
                            <span class="status-badge status-${request.status}">
                                ${status.name}
                            </span>
                        </div>
                        <div class="small text-muted">
                            <i class="fas fa-id-card me-1"></i>${request.nationalId} | 
                            <i class="fas ${category.icon} me-1"></i>${category.name} | 
                            <i class="fas fa-calendar me-1"></i>${formatDate(request.date)}
                        </div>
                    </div>
                `;
                
                container.append(card);
            });
        }

        // تصدير البيانات
        function exportData() {
            const dataStr = JSON.stringify(allRequests, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `طلبات_المواطنين_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('تم تصدير البيانات بنجاح', 'success');
        }

        // تسجيل الخروج
        function logout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                showNotification('جارٍ تسجيل الخروج...', 'info');
                setTimeout(() => {
                    localStorage.removeItem('citizenRequests');
                    window.location.reload();
                }, 1000);
            }
        }

        // تحديث البيانات
        function refreshData() {
            showNotification('جاري تحديث البيانات...', 'info');
            setTimeout(() => {
                loadDashboard();
                showNotification('تم تحديث البيانات', 'success');
            }, 500);
        }

        // عرض رسالة ترحيب
        function showWelcome() {
            const firstVisit = !localStorage.getItem('appFirstVisit');
            if (firstVisit) {
                showNotification('مرحباً بك في نظام متابعة طلبات المواطنين!', 'info');
                localStorage.setItem('appFirstVisit', 'true');
            }
        }

        // تسجيل النشاط
        function logActivity(requestId, oldStatus, newStatus, comment = '') {
            const activityLog = JSON.parse(localStorage.getItem('activityLog')) || [];
            
            activityLog.push({
                requestId: requestId,
                oldStatus: oldStatus,
                newStatus: newStatus,
                comment: comment,
                changedBy: 'عضو مجلس النواب',
                changedAt: new Date().toISOString()
            });
            
            localStorage.setItem('activityLog', JSON.stringify(activityLog));
        }

        // إظهار إشعار
        function showNotification(message, type = 'info') {
            const notificationId = 'notif-' + Date.now();
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type];
            
            const notificationHtml = `
                <div id="${notificationId}" class="notification alert alert-${type} alert-dismissible fade show">
                    <i class="fas ${icon} me-2"></i>${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('body').append(notificationHtml);
            
            // تشغيل الصوت
            if (type === 'success') {
                playNotificationSound();
            }
            
            // إزالة الإشعار بعد 4 ثواني
            setTimeout(() => {
                $(`#${notificationId}`).alert('close');
            }, 4000);
        }

        // تشغيل صوت الإشعار
        function playNotificationSound() {
            try {
                // إنشاء صوت باستخدام Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('تعذر تشغيل الصوت');
            }
        }

        // حفظ البيانات
        function saveData() {
            localStorage.setItem('citizenRequests', JSON.stringify(allRequests));
        }

        // تسجيل Service Worker
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                const sw = `
                    const CACHE_NAME = 'citizen-requests-v3';
                    self.addEventListener('install', event => {
                        event.waitUntil(caches.open(CACHE_NAME));
                    });
                    self.addEventListener('fetch', event => {
                        event.respondWith(fetch(event.request));
                    });
                `;
                
                const blob = new Blob([sw], { type: 'application/javascript' });
                const url = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(url)
                    .then(() => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            }
        }

        // وظائف مساعدة
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG');
        }
        
        function getStatusText(status) {
            return statuses[status]?.name || status;
        }
        
        function getCategoryText(category) {
            return categories[category]?.name || category;
        }

        // تهيئة عند تحميل الصفحة
        $(window).on('load', function() {
            // ضبط الطول للجوال
            const vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        });
    </script>
</body>
</html>