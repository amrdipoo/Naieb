<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة طلبات المواطنين - عضو مجلس النواب</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --electricity-color: #f97316;
            --health-color: #ec4899;
            --water-color: #0ea5e9;
            --sanitation-color: #8b5cf6;
            --education-color: #84cc16;
            --transport-color: #6366f1;
            --telecom-color: #06b6d4;
            --housing-color: #14b8a6;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow-x: hidden;
            transition: all 0.3s;
            font-size: 16px;
            line-height: 1.5;
        }
        
        /* شاشة الترحيب */
        .welcome-screen {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }
        
        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }
        
        .welcome-title {
            font-size: 36px;
            margin-bottom: 10px;
        }
        
        .welcome-subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .welcome-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        /* أنماط تسجيل الدخول */
        .auth-page {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            padding: 20px;
        }
        
        .auth-container {
            width: 100%;
            max-width: 450px;
        }
        
        .auth-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .auth-header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .auth-body {
            padding: 30px;
        }
        
        /* التطبيق الرئيسي */
        .app-content {
            display: none;
            background-color: #f8fafc;
            min-height: 100vh;
        }
        
        .sidebar {
            background: linear-gradient(180deg, var(--primary-color) 0%, #1e40af 100%);
            min-height: 100vh;
            color: white;
            position: fixed;
            width: 250px;
            box-shadow: 3px 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            margin: 5px 15px;
            border-radius: 10px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
        }
        
        .nav-link:hover, .nav-link.active {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(-5px);
        }
        
        .nav-link i {
            width: 25px;
            text-align: center;
            margin-left: 10px;
        }
        
        .main-content {
            margin-right: 250px;
            padding: 20px;
            min-height: 100vh;
        }
        
        @media (max-width: 992px) {
            .sidebar {
                width: 70px;
            }
            
            .sidebar-header h3,
            .nav-link span {
                display: none;
            }
            
            .main-content {
                margin-right: 70px;
            }
            
            .nav-link {
                justify-content: center;
                padding: 15px;
                margin: 5px 10px;
            }
            
            .nav-link i {
                margin-left: 0;
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
                margin-right: 70px;
            }
            
            .welcome-title {
                font-size: 24px;
            }
            
            .auth-header h1 {
                font-size: 24px;
            }
        }
        
        /* أنماط GitHub */
        .github-badge {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1050;
        }
        
        .sync-status {
            position: fixed;
            bottom: 80px;
            left: 30px;
            z-index: 1050;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 20px;
            padding: 8px 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            font-size: 0.85rem;
        }
        
        .sync-indicator.syncing {
            background: linear-gradient(135deg, #3b82f6, #1e3a8a);
            color: white;
        }
        
        .sync-indicator.success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .sync-indicator.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        
        .sync-spinner {
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* أنماط عامة */
        .stat-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
            overflow: hidden;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .status-badge {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .status-submitted { background-color: #dbeafe; color: var(--primary-color); }
        .status-pending { background-color: #fef3c7; color: var(--warning-color); }
        .status-approved { background-color: #d1fae5; color: var(--success-color); }
        .status-rejected { background-color: #fee2e2; color: var(--danger-color); }
        
        .category-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .category-electricity { background-color: #ffedd5; color: var(--electricity-color); border-left: 4px solid var(--electricity-color); }
        .category-health { background-color: #fce7f3; color: var(--health-color); border-left: 4px solid var(--health-color); }
        .category-water { background-color: #e0f2fe; color: var(--water-color); border-left: 4px solid var(--water-color); }
        .category-sanitation { background-color: #f3e8ff; color: var(--sanitation-color); border-left: 4px solid var(--sanitation-color); }
        .category-education { background-color: #f0fdf4; color: var(--education-color); border-left: 4px solid var(--education-color); }
        .category-transport { background-color: #eef2ff; color: var(--transport-color); border-left: 4px solid var(--transport-color); }
        .category-telecom { background-color: #ecfeff; color: var(--telecom-color); border-left: 4px solid var(--telecom-color); }
        .category-housing { background-color: #f0fdfa; color: var(--housing-color); border-left: 4px solid var(--housing-color); }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin: 0 auto 15px;
        }
        
        .add-btn {
            position: fixed;
            bottom: 30px;
            left: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            box-shadow: 0 4px 15px rgba(30, 58, 138, 0.4);
            z-index: 100;
            transition: all 0.3s;
        }
        
        .add-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(30, 58, 138, 0.6);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
        }
    </style>
</head>
<body>
    <!-- شاشة الترحيب -->
    <div id="welcomeScreen" class="welcome-screen">
        <div class="welcome-logo">
            <i class="fas fa-hands-helping"></i>
        </div>
        <h1 class="welcome-title">نظام متابعة طلبات المواطنين</h1>
        <p class="welcome-subtitle">عضو مجلس النواب</p>
        <div class="welcome-buttons">
            <button class="btn btn-light btn-lg" id="loginWelcomeBtn">
                <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
            </button>
            <button class="btn btn-outline-light btn-lg" id="registerWelcomeBtn">
                <i class="fas fa-user-plus me-2"></i>إنشاء حساب جديد
            </button>
        </div>
    </div>

    <!-- صفحة تسجيل الدخول -->
    <div id="loginPage" class="auth-page" style="display: none;">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="logo">
                        <i class="fas fa-hands-helping"></i>
                    </div>
                    <h1>تسجيل الدخول</h1>
                    <p>نظام متابعة طلبات المواطنين</p>
                </div>
                <div class="auth-body">
                    <div id="loginAlert" class="alert alert-danger d-none"></div>
                    <form id="loginForm">
                        <div class="mb-3">
                            <label for="username" class="form-label">
                                <i class="fas fa-user me-2"></i>اسم المستخدم
                            </label>
                            <input type="text" class="form-control" id="username" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">
                                <i class="fas fa-lock me-2"></i>كلمة المرور
                            </label>
                            <div class="password-input-group">
                                <input type="password" class="form-control" id="password" required>
                                <button type="button" class="password-toggle" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-auth" id="loginBtn">
                            <i class="fas fa-sign-in-alt me-2"></i>تسجيل الدخول
                        </button>
                        <div class="auth-footer">
                            <a href="#" id="showRegisterLink">إنشاء حساب جديد</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- صفحة إنشاء حساب -->
    <div id="registerPage" class="auth-page" style="display: none;">
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <div class="logo">
                        <i class="fas fa-user-plus"></i>
                    </div>
                    <h1>إنشاء حساب جديد</h1>
                    <p>انضم إلى نظام متابعة طلبات المواطنين</p>
                </div>
                <div class="auth-body">
                    <div id="registerAlert" class="alert alert-danger d-none"></div>
                    <form id="registerForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="fullName" class="form-label">الاسم الكامل</label>
                                <input type="text" class="form-control" id="fullName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="regUsername" class="form-label">اسم المستخدم</label>
                                <input type="text" class="form-control" id="regUsername" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="regPassword" class="form-label">كلمة المرور</label>
                            <input type="password" class="form-control" id="regPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="role" class="form-label">الدور الوظيفي</label>
                            <select class="form-select" id="role" required>
                                <option value="assistant">مساعد عضو مجلس النواب</option>
                                <option value="coordinator">منسق طلبات</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-auth" id="registerBtn">
                            <i class="fas fa-user-plus me-2"></i>إنشاء حساب
                        </button>
                        <div class="auth-footer">
                            <a href="#" id="showLoginLink">تسجيل الدخول</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="appContent" class="app-content" style="display: none;">
        <!-- الشريط الجانبي -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-circle" id="userAvatarIcon"></i>
                    </div>
                    <div class="user-name" id="sidebarUserName">عضو مجلس النواب</div>
                    <div class="user-role" id="sidebarUserRole">المسؤول</div>
                </div>
            </div>
            <ul class="nav flex-column mt-4">
                <li class="nav-item">
                    <a class="nav-link active" href="#" id="dashboardLink">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>لوحة التحكم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="allRequestsLink">
                        <i class="fas fa-list"></i>
                        <span>جميع الطلبات</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="searchLink">
                        <i class="fas fa-search"></i>
                        <span>بحث متقدم</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="categoriesLink">
                        <i class="fas fa-layer-group"></i>
                        <span>الهيئات الحكومية</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="reportsLink">
                        <i class="fas fa-chart-bar"></i>
                        <span>التقارير</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="profileLink">
                        <i class="fas fa-user-circle"></i>
                        <span>الملف الشخصي</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#" id="settingsLink">
                        <i class="fas fa-cog"></i>
                        <span>الإعدادات</span>
                    </a>
                </li>
            </ul>
            <div class="mt-auto p-3">
                <button class="btn btn-sm btn-outline-light w-100" id="logoutBtn">
                    <i class="fas fa-sign-out-alt me-1"></i>
                    <span>تسجيل الخروج</span>
                </button>
            </div>
        </nav>

        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <!-- لوحة التحكم -->
            <div id="dashboardSection" class="page-section">
                <!-- شريط البحث -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card shadow">
                            <div class="card-body">
                                <div class="row align-items-center">
                                    <div class="col-md-8 mb-3 mb-md-0">
                                        <div class="input-group">
                                            <input type="text" class="form-control" id="mainSearchInput" placeholder="ابحث...">
                                            <button class="btn btn-primary" id="searchBtn">
                                                <i class="fas fa-search"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <button class="btn btn-primary w-100" id="newRequestBtn">
                                            <i class="fas fa-plus me-2"></i>طلب جديد
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- الإحصائيات -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-4">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-primary text-white me-3">
                                        <i class="fas fa-file-alt"></i>
                                    </div>
                                    <div>
                                        <div class="h5 mb-0" id="totalRequests">0</div>
                                        <div class="text-muted">إجمالي الطلبات</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-success text-white me-3">
                                        <i class="fas fa-plus-circle"></i>
                                    </div>
                                    <div>
                                        <div class="h5 mb-0" id="newRequests">0</div>
                                        <div class="text-muted">طلبات جديدة</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-warning text-white me-3">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div>
                                        <div class="h5 mb-0" id="pendingRequests">0</div>
                                        <div class="text-muted">قيد الانتظار</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="card stat-card">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <div class="stat-icon bg-info text-white me-3">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div>
                                        <div class="h5 mb-0" id="completionRate">0%</div>
                                        <div class="text-muted">نسبة الإنجاز</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- جدول الطلبات -->
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-list me-2"></i>الطلبات الأخيرة
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>اسم مقدم الطلب</th>
                                        <th>عنوان الطلب</th>
                                        <th>الهيئة</th>
                                        <th>التاريخ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="requestsTableBody">
                                    <!-- البيانات تظهر هنا -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- صفحات أخرى -->
            <div id="searchSection" class="page-section" style="display: none;">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">بحث متقدم</h5>
                    </div>
                    <div class="card-body">
                        <p>محتوى البحث المتقدم سيظهر هنا...</p>
                    </div>
                </div>
            </div>

            <div id="categoriesSection" class="page-section" style="display: none;">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">الهيئات الحكومية</h5>
                    </div>
                    <div class="card-body">
                        <p>محتوى الهيئات الحكومية سيظهر هنا...</p>
                    </div>
                </div>
            </div>

            <div id="reportsSection" class="page-section" style="display: none;">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">التقارير</h5>
                    </div>
                    <div class="card-body">
                        <p>محتوى التقارير سيظهر هنا...</p>
                    </div>
                </div>
            </div>

            <div id="profileSection" class="page-section" style="display: none;">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">الملف الشخصي</h5>
                    </div>
                    <div class="card-body">
                        <p>محتوى الملف الشخصي سيظهر هنا...</p>
                    </div>
                </div>
            </div>

            <div id="settingsSection" class="page-section" style="display: none;">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">الإعدادات</h5>
                    </div>
                    <div class="card-body">
                        <p>محتوى الإعدادات سيظهر هنا...</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- زر إضافة طلب جديد -->
        <button class="add-btn" id="floatingAddBtn" style="display: none;">
            <i class="fas fa-plus fa-lg"></i>
        </button>
    </div>

    <!-- شارة GitHub -->
    <div class="github-badge">
        <button class="btn btn-dark btn-sm" id="githubSyncBtn" title="إعدادات المزامنة">
            <i class="fab fa-github"></i>
            <span class="d-none d-md-inline"> Sync</span>
        </button>
    </div>

    <!-- مؤشر المزامنة -->
    <div class="sync-status" id="syncStatus" style="display: none;">
        <div class="sync-indicator" id="syncIndicator">
            <i class="fas fa-sync sync-spinner me-2"></i>
            <span id="syncMessage">جاري المزامنة...</span>
        </div>
    </div>

    <!-- نموذج إعدادات GitHub -->
    <div class="modal fade" id="githubConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">
                        <i class="fab fa-github me-2"></i>إعدادات مزامنة GitHub
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="githubConfigAlert" class="alert alert-warning d-none">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <span id="githubConfigMessage"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="githubToken" class="form-label fw-bold">
                            <i class="fas fa-key me-2"></i>GitHub Personal Access Token
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="githubToken" 
                                   placeholder="أدخل الـ Token الخاص بك">
                            <button class="btn btn-outline-secondary" type="button" id="toggleTokenVisibility">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <small class="text-muted">
                            تحتاج إلى <code>gist</code> صلاحية. 
                            <a href="https://github.com/settings/tokens/new" target="_blank">إنشاء Token جديد</a>
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="githubUsername" class="form-label fw-bold">
                            <i class="fas fa-user me-2"></i>اسم مستخدم GitHub
                        </label>
                        <input type="text" class="form-control" id="githubUsername" 
                               placeholder="أدخل اسم المستخدم">
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="autoSyncEnabled" checked>
                        <label class="form-check-label" for="autoSyncEnabled">
                            المزامنة التلقائية عند كل تغيير
                        </label>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="syncOnStartup" checked>
                        <label class="form-check-label" for="syncOnStartup">
                            المزامنة عند بدء التشغيل
                        </label>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-outline-primary w-100 mb-2" id="testGithubConnection">
                            <i class="fas fa-plug me-2"></i>اختبار الاتصال
                        </button>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-danger flex-fill" id="clearGithubConfig">
                                <i class="fas fa-trash me-2"></i>مسح التكوين
                            </button>
                            <button class="btn btn-primary flex-fill" id="saveGithubConfig">
                                <i class="fas fa-save me-2"></i>حفظ التكوين
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مكتبات JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // ==================== تعريف البيانات الأساسية ====================
        const categories = {
            'electricity': { name: 'كهرباء', color: '#f97316', icon: 'fas fa-bolt' },
            'health': { name: 'صحة', color: '#ec4899', icon: 'fas fa-hospital' },
            'water': { name: 'مياه', color: '#0ea5e9', icon: 'fas fa-tint' },
            'sanitation': { name: 'صرف صحي', color: '#8b5cf6', icon: 'fas fa-toilet' },
            'education': { name: 'تعليم', color: '#84cc16', icon: 'fas fa-graduation-cap' },
            'transport': { name: 'مواصلات', color: '#6366f1', icon: 'fas fa-bus' },
            'telecom': { name: 'اتصالات', color: '#06b6d4', icon: 'fas fa-wifi' },
            'housing': { name: 'إسكان', color: '#14b8a6', icon: 'fas fa-home' }
        };

        const statuses = {
            'submitted': { name: 'تم التقديم', color: '#3b82f6', icon: 'fas fa-file-import' },
            'pending': { name: 'انتظار الرد', color: '#f59e0b', icon: 'fas fa-clock' },
            'approved': { name: 'موافقة', color: '#10b981', icon: 'fas fa-check-circle' },
            'rejected': { name: 'غير موافقة', color: '#ef4444', icon: 'fas fa-times-circle' }
        };

        // ==================== بيانات التطبيق ====================
        let allRequests = JSON.parse(localStorage.getItem('citizenRequests')) || [
            {
                id: 1001,
                nationalId: "29801011234567",
                applicantName: "أحمد محمد علي",
                requestTitle: "طلب توصيل خدمة كهرباء",
                requestDate: "2023-12-15",
                category: "electricity",
                status: "pending",
                priority: "high"
            },
            {
                id: 1002,
                nationalId: "29905052345678",
                applicantName: "سارة خالد حسن",
                requestTitle: "طلب إنشاء مركز صحي",
                requestDate: "2023-12-10",
                category: "health",
                status: "approved",
                priority: "medium"
            }
        ];

        let currentPage = 1;
        let filteredRequests = [...allRequests];
        let currentUser = null;

        // ==================== إعدادات GitHub ====================
        let githubConfig = JSON.parse(localStorage.getItem('githubConfig')) || {
            token: '',
            username: '',
            gistId: '',
            autoSync: true,
            syncOnStartup: true,
            lastSync: null
        };

        let isSyncing = false;
        let syncTimeout = null;

        // ==================== تهيئة التطبيق ====================
        $(document).ready(function() {
            initializeAuth();
            initializeGitHub();
            checkUserSession();
        });

        // ==================== نظام المصادقة ====================
        function initializeAuth() {
            if (!localStorage.getItem('systemUsers')) {
                const defaultUsers = [
                    {
                        id: 1,
                        username: 'admin',
                        password: '123456',
                        fullName: 'عضو مجلس النواب',
                        role: 'admin',
                        isActive: true
                    }
                ];
                localStorage.setItem('systemUsers', JSON.stringify(defaultUsers));
            }
            
            setupAuthEvents();
        }

        function setupAuthEvents() {
            // شاشة الترحيب
            $('#loginWelcomeBtn').click(function() {
                $('#welcomeScreen').hide();
                $('#loginPage').show();
            });
            
            $('#registerWelcomeBtn').click(function() {
                $('#welcomeScreen').hide();
                $('#registerPage').show();
            });
            
            // تسجيل الدخول
            $('#showRegisterLink').click(function(e) {
                e.preventDefault();
                $('#loginPage').hide();
                $('#registerPage').show();
            });
            
            $('#showLoginLink').click(function(e) {
                e.preventDefault();
                $('#registerPage').hide();
                $('#loginPage').show();
            });
            
            $('#loginForm').submit(function(e) {
                e.preventDefault();
                loginUser();
            });
            
            $('#registerForm').submit(function(e) {
                e.preventDefault();
                registerUser();
            });
        }

        function loginUser() {
            const username = $('#username').val();
            const password = $('#password').val();
            
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            const user = users.find(u => u.username === username && u.password === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                startApplication();
            } else {
                $('#loginAlert').removeClass('d-none').text('اسم المستخدم أو كلمة المرور غير صحيحة');
            }
        }

        function registerUser() {
            const fullName = $('#fullName').val();
            const username = $('#regUsername').val();
            const password = $('#regPassword').val();
            const role = $('#role').val();
            
            const users = JSON.parse(localStorage.getItem('systemUsers') || '[]');
            
            const newUser = {
                id: users.length + 1,
                username: username,
                password: password,
                fullName: fullName,
                role: role,
                isActive: true
            };
            
            users.push(newUser);
            localStorage.setItem('systemUsers', JSON.stringify(users));
            
            $('#registerAlert').removeClass('d-none alert-danger').addClass('alert-success')
                .html('تم إنشاء الحساب بنجاح! <a href="#" id="goToLogin">تسجيل الدخول</a>');
            
            $('#goToLogin').click(function(e) {
                e.preventDefault();
                $('#registerPage').hide();
                $('#loginPage').show();
            });
        }

        // ==================== نظام GitHub ====================
        function initializeGitHub() {
            // زر GitHub
            $('#githubSyncBtn').click(function() {
                $('#githubConfigModal').modal('show');
                loadGitHubConfig();
            });
            
            // تبديل رؤية Token
            $('#toggleTokenVisibility').click(function() {
                const input = $('#githubToken');
                const icon = $(this).find('i');
                if (input.attr('type') === 'password') {
                    input.attr('type', 'text');
                    icon.removeClass('fa-eye').addClass('fa-eye-slash');
                } else {
                    input.attr('type', 'password');
                    icon.removeClass('fa-eye-slash').addClass('fa-eye');
                }
            });
            
            // اختبار الاتصال
            $('#testGithubConnection').click(async function() {
                await testGitHubConnection();
            });
            
            // حفظ الإعدادات
            $('#saveGithubConfig').click(function() {
                saveGitHubConfig();
            });
            
            // مسح الإعدادات
            $('#clearGithubConfig').click(function() {
                if (confirm('هل أنت متأكد من مسح إعدادات GitHub؟')) {
                    clearGitHubConfig();
                }
            });
        }

        function loadGitHubConfig() {
            $('#githubToken').val(githubConfig.token);
            $('#githubUsername').val(githubConfig.username);
            $('#autoSyncEnabled').prop('checked', githubConfig.autoSync);
            $('#syncOnStartup').prop('checked', githubConfig.syncOnStartup);
        }

        async function testGitHubConnection() {
            const token = $('#githubToken').val();
            const username = $('#githubUsername').val();
            
            if (!token || !username) {
                showGitHubAlert('الرجاء إدخال Token واسم المستخدم', 'warning');
                return;
            }
            
            showGitHubAlert('جاري اختبار الاتصال...', 'info');
            
            try {
                const response = await fetch('https://api.github.com/user', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const userData = await response.json();
                    if (userData.login === username) {
                        showGitHubAlert('تم الاتصال بنجاح!', 'success');
                        // البحث عن Gist موجود أو إنشاء جديد
                        await findOrCreateGist(token);
                    } else {
                        showGitHubAlert('اسم المستخدم غير مطابق', 'warning');
                    }
                } else {
                    showGitHubAlert('فشل الاتصال: ' + response.status, 'danger');
                }
            } catch (error) {
                showGitHubAlert('خطأ في الاتصال: ' + error.message, 'danger');
            }
        }

        async function findOrCreateGist(token) {
            try {
                // البحث عن Gist موجود
                const response = await fetch('https://api.github.com/gists', {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const gists = await response.json();
                    const existingGist = gists.find(g => g.description === 'Citizen Requests System Data');
                    
                    if (existingGist) {
                        githubConfig.gistId = existingGist.id;
                        showGitHubAlert('تم العثور على تخزين بيانات موجود', 'success');
                    } else {
                        // إنشاء Gist جديد
                        await createNewGist(token);
                    }
                    
                    localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                }
            } catch (error) {
                console.error('Gist error:', error);
            }
        }

        async function createNewGist(token) {
            const data = {
                requests: allRequests,
                users: JSON.parse(localStorage.getItem('systemUsers') || '[]'),
                lastSync: new Date().toISOString()
            };
            
            const gistData = {
                description: 'Citizen Requests System Data',
                public: false,
                files: {
                    'citizen-requests-data.json': {
                        content: JSON.stringify(data, null, 2)
                    }
                }
            };
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    githubConfig.gistId = gist.id;
                    showGitHubAlert('تم إنشاء تخزين بيانات جديد', 'success');
                }
            } catch (error) {
                console.error('Create gist error:', error);
            }
        }

        function saveGitHubConfig() {
            githubConfig.token = $('#githubToken').val();
            githubConfig.username = $('#githubUsername').val();
            githubConfig.autoSync = $('#autoSyncEnabled').is(':checked');
            githubConfig.syncOnStartup = $('#syncOnStartup').is(':checked');
            
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            showGitHubAlert('تم حفظ الإعدادات بنجاح', 'success');
            
            // إغلاق النافذة بعد ثانية
            setTimeout(() => {
                $('#githubConfigModal').modal('hide');
            }, 1000);
        }

        function clearGitHubConfig() {
            githubConfig = {
                token: '',
                username: '',
                gistId: '',
                autoSync: true,
                syncOnStartup: true,
                lastSync: null
            };
            
            localStorage.removeItem('githubConfig');
            loadGitHubConfig();
            showGitHubAlert('تم مسح إعدادات GitHub', 'success');
        }

        function showGitHubAlert(message, type) {
            const alert = $('#githubConfigAlert');
            alert.removeClass('d-none alert-warning alert-success alert-danger alert-info')
                 .addClass(`alert-${type}`)
                 .html(`<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>${message}`);
        }

        // المزامنة إلى GitHub
        async function syncToGist() {
            if (!githubConfig.token || !githubConfig.gistId) {
                showNotification('لم يتم تكوين اتصال GitHub', 'warning');
                return;
            }
            
            if (isSyncing) return;
            isSyncing = true;
            showSyncStatus('جاري المزامنة مع GitHub...', 'syncing');
            
            try {
                const data = {
                    requests: allRequests,
                    users: JSON.parse(localStorage.getItem('systemUsers') || '[]'),
                    lastSync: new Date().toISOString(),
                    version: '1.0'
                };
                
                const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        files: {
                            'citizen-requests-data.json': {
                                content: JSON.stringify(data, null, 2)
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    githubConfig.lastSync = new Date().toISOString();
                    localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                    
                    showSyncStatus('تمت المزامنة بنجاح', 'success');
                    showNotification('تم حفظ البيانات على GitHub', 'success');
                    
                    setTimeout(() => hideSyncStatus(), 3000);
                } else {
                    throw new Error('فشل المزامنة');
                }
            } catch (error) {
                showSyncStatus('فشلت المزامنة', 'error');
                showNotification('فشلت المزامنة: ' + error.message, 'danger');
                setTimeout(() => hideSyncStatus(), 5000);
            } finally {
                isSyncing = false;
            }
        }

        // المزامنة من GitHub
        async function syncFromGist() {
            if (!githubConfig.token || !githubConfig.gistId) return;
            
            if (isSyncing) return;
            isSyncing = true;
            showSyncStatus('جاري جلب البيانات...', 'syncing');
            
            try {
                const response = await fetch(`https://api.github.com/gists/${githubConfig.gistId}`, {
                    headers: {
                        'Authorization': `token ${githubConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    const content = gist.files['citizen-requests-data.json'].content;
                    const data = JSON.parse(content);
                    
                    if (data.requests) {
                        allRequests = data.requests;
                        localStorage.setItem('citizenRequests', JSON.stringify(allRequests));
                    }
                    
                    githubConfig.lastSync = new Date().toISOString();
                    localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
                    
                    showSyncStatus('تم جلب البيانات بنجاح', 'success');
                    showNotification('تم تحديث البيانات من GitHub', 'success');
                    
                    refreshData();
                    setTimeout(() => hideSyncStatus(), 3000);
                }
            } catch (error) {
                showSyncStatus('فشل جلب البيانات', 'error');
                setTimeout(() => hideSyncStatus(), 5000);
            } finally {
                isSyncing = false;
            }
        }

        function showSyncStatus(message, status) {
            const indicator = $('#syncIndicator');
            $('#syncStatus').show();
            indicator.removeClass('syncing success error').addClass(status);
            $('#syncMessage').text(message);
        }

        function hideSyncStatus() {
            $('#syncStatus').hide();
        }

        // المزامنة التلقائية
        function autoSync() {
            if (githubConfig.autoSync && githubConfig.token && githubConfig.gistId) {
                clearTimeout(syncTimeout);
                syncTimeout = setTimeout(syncToGist, 2000);
            }
        }

        // المزامنة عند بدء التشغيل
        function startupSync() {
            if (githubConfig.syncOnStartup && githubConfig.token && githubConfig.gistId) {
                setTimeout(syncFromGist, 1000);
            }
        }

        // ==================== التطبيق الرئيسي ====================
        function checkUserSession() {
            const userData = localStorage.getItem('currentUser');
            if (userData) {
                currentUser = JSON.parse(userData);
                startApplication();
            }
        }

        function startApplication() {
            $('#welcomeScreen').hide();
            $('#loginPage').hide();
            $('#registerPage').hide();
            $('#appContent').show();
            
            initializeApp();
            startupSync();
        }

        function initializeApp() {
            updateUserInterface();
            setupAppEvents();
            renderRequestsTable();
            updateStatistics();
            
            // إعداد استماع للتغييرات للمزامنة
            $(document).on('requestChanged', function() {
                autoSync();
            });
        }

        function updateUserInterface() {
            if (currentUser) {
                $('#sidebarUserName').text(currentUser.fullName);
                $('#sidebarUserRole').text(getRoleName(currentUser.role));
            }
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'المسؤول',
                'assistant': 'مساعد',
                'coordinator': 'منسق'
            };
            return roles[role] || 'مستخدم';
        }

        function setupAppEvents() {
            // التنقل
            $('.nav-link').click(function(e) {
                e.preventDefault();
                $('.nav-link').removeClass('active');
                $(this).addClass('active');
                
                const pageId = $(this).attr('id').replace('Link', '');
                showPage(pageId);
            });
            
            // تسجيل الخروج
            $('#logoutBtn').click(function() {
                if (confirm('هل تريد تسجيل الخروج؟')) {
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                    location.reload();
                }
            });
            
            // بحث
            $('#searchBtn').click(function() {
                performSearch();
            });
            
            $('#mainSearchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    performSearch();
                }
            });
            
            // طلب جديد
            $('#newRequestBtn, #floatingAddBtn').click(function() {
                openNewRequestModal();
            });
        }

        function showPage(pageId) {
            $('.page-section').hide();
            $(`#${pageId}Section`).show();
            
            if (pageId === 'dashboard' || pageId === 'allRequests') {
                $('#floatingAddBtn').show();
            } else {
                $('#floatingAddBtn').hide();
            }
        }

        function performSearch() {
            const searchTerm = $('#mainSearchInput').val().toLowerCase();
            if (searchTerm) {
                filteredRequests = allRequests.filter(request => 
                    request.applicantName.toLowerCase().includes(searchTerm) ||
                    request.requestTitle.toLowerCase().includes(searchTerm) ||
                    request.nationalId.includes(searchTerm)
                );
            } else {
                filteredRequests = [...allRequests];
            }
            renderRequestsTable();
        }

        function renderRequestsTable() {
            const tbody = $('#requestsTableBody');
            tbody.empty();
            
            filteredRequests.slice(0, 10).forEach(request => {
                const category = categories[request.category];
                const status = statuses[request.status];
                
                const row = `
                    <tr>
                        <td>${request.id}</td>
                        <td>${request.applicantName}</td>
                        <td>${request.requestTitle}</td>
                        <td>
                            <span class="category-badge ${getCategoryClass(request.category)}">
                                <i class="${category.icon} me-1"></i>${category.name}
                            </span>
                        </td>
                        <td>${formatDate(request.requestDate)}</td>
                        <td>
                            <span class="status-badge ${getStatusClass(request.status)}">
                                ${status.name}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="showRequestDetails(${request.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updateStatistics() {
            $('#totalRequests').text(allRequests.length);
            $('#newRequests').text(allRequests.filter(r => 
                new Date(r.requestDate) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
            ).length);
            $('#pendingRequests').text(allRequests.filter(r => r.status === 'pending').length);
            
            const completed = allRequests.filter(r => r.status === 'approved').length;
            $('#completionRate').text(allRequests.length ? Math.round((completed / allRequests.length) * 100) + '%' : '0%');
        }

        function openNewRequestModal() {
            const modalHtml = `
                <div class="modal fade" id="newRequestModal">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header bg-primary text-white">
                                <h5 class="modal-title">طلب جديد</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <form id="newRequestForm">
                                    <div class="mb-3">
                                        <label class="form-label">اسم مقدم الطلب</label>
                                        <input type="text" class="form-control" id="newApplicantName" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">عنوان الطلب</label>
                                        <input type="text" class="form-control" id="newRequestTitle" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">الهيئة الحكومية</label>
                                        <select class="form-select" id="newCategory" required>
                                            ${Object.entries(categories).map(([key, cat]) => 
                                                `<option value="${key}">${cat.name}</option>`
                                            ).join('')}
                                        </select>
                                    </div>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                                <button type="button" class="btn btn-primary" id="saveNewRequestBtn">حفظ</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            $('body').append(modalHtml);
            $('#newRequestModal').modal('show');
            
            $('#saveNewRequestBtn').off('click').on('click', function() {
                saveNewRequest();
            });
            
            $('#newRequestModal').on('hidden.bs.modal', function() {
                $(this).remove();
            });
        }

        function saveNewRequest() {
            const newRequest = {
                id: allRequests.length ? Math.max(...allRequests.map(r => r.id)) + 1 : 1001,
                applicantName: $('#newApplicantName').val(),
                requestTitle: $('#newRequestTitle').val(),
                category: $('#newCategory').val(),
                status: 'submitted',
                requestDate: new Date().toISOString().split('T')[0],
                nationalId: '30000000000000',
                priority: 'medium'
            };
            
            allRequests.unshift(newRequest);
            localStorage.setItem('citizenRequests', JSON.stringify(allRequests));
            
            $('#newRequestModal').modal('hide');
            showNotification('تم إضافة الطلب بنجاح', 'success');
            
            refreshData();
            $(document).trigger('requestChanged');
        }

        function refreshData() {
            renderRequestsTable();
            updateStatistics();
        }

        // وظائف مساعدة
        function getCategoryClass(category) {
            return `category-${category}`;
        }

        function getStatusClass(status) {
            return `status-${status}`;
        }

        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ar-EG');
        }

        function showNotification(message, type) {
            const notification = `
                <div class="toast align-items-center text-white bg-${type} border-0 position-fixed top-0 end-0 m-3" role="alert">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                </div>
            `;
            
            $('body').append(notification);
            const toast = new bootstrap.Toast($('.toast').last()[0]);
            toast.show();
            
            setTimeout(() => {
                $('.toast').last().remove();
            }, 3000);
        }

        // تعريف الوظائف العامة
        window.showRequestDetails = function(id) {
            const request = allRequests.find(r => r.id === id);
            if (request) {
                alert(`تفاصيل الطلب #${id}\nالاسم: ${request.applicantName}\nالعنوان: ${request.requestTitle}\nالحالة: ${statuses[request.status].name}`);
            }
        };

        window.syncToGist = syncToGist;
        window.syncFromGist = syncFromGist;
        window.showGitHubConfig = function() {
            $('#githubConfigModal').modal('show');
        };
    </script>
</body>
</html>
