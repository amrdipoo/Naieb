<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام متابعة طلبات المواطنين - عضو مجلس النواب</title>
    
    <!-- CSS الأساسي فقط - بدون تفاصيل -->
    <style>
        /* أنماط أساسية فقط */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        #app-loader {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            text-align: center;
        }
        
        .loader-logo {
            font-size: 4rem;
            margin-bottom: 2rem;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.05); }
        }
        
        .loader-text {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        .loader-subtext {
            opacity: 0.8;
            margin-bottom: 2rem;
        }
        
        .loader-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        #error-container {
            display: none;
            padding: 2rem;
            text-align: center;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 500px;
            margin: 2rem auto;
        }
        
        .error-icon {
            font-size: 3rem;
            color: #dc3545;
            margin-bottom: 1rem;
        }
        
        /* حماية إضافية */
        #protection-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.95);
            color: white;
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999999;
            text-align: center;
            padding: 2rem;
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل الأولية فقط -->
    <div id="app-loader">
        <div class="loader-logo">
            <i class="fas fa-hands-helping"></i>
        </div>
        <div class="loader-text">نظام متابعة طلبات المواطنين</div>
        <div class="loader-subtext">عضو مجلس النواب</div>
        <div class="loader-spinner"></div>
        <div class="loader-subtext" style="margin-top: 2rem; font-size: 0.9rem;">
            جاري التحقق من الصلاحيات وتحميل النظام...
        </div>
    </div>
    
    <!-- حاوية التطبيق الرئيسية (سيتم إخفاؤها في Shadow DOM) -->
    <div id="app-container" style="display: none;"></div>
    
    <!-- حاوية الأخطاء -->
    <div id="error-container">
        <div class="error-icon">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        <h3 id="error-title">حدث خطأ</h3>
        <p id="error-message">تعذر تحميل النظام. يرجى المحاولة مرة أخرى.</p>
        <button id="retry-btn" class="btn btn-primary mt-3">إعادة المحاولة</button>
    </div>
    
    <!-- طبقة حماية -->
    <div id="protection-overlay">
        <div>
            <h2 style="color: #ff4444; margin-bottom: 1rem;">⚠️ تم اكتشاف محاولة اختراق</h2>
            <p>تم إيقاف النظام لأسباب أمنية.</p>
            <p>يرجى إعادة تحميل الصفحة.</p>
            <button onclick="location.reload()" class="btn btn-light mt-3">إعادة التحميل</button>
        </div>
    </div>

    <!-- مكتبات خارجية فقط -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- محمل النظام المحمي -->
    <script>
        // ===================== نظام الحماية الرئيسي =====================
        (function() {
            'use strict';
            
            // المفاتيح والمتغيرات المحمية
            const SYSTEM_KEY = 'CITIZEN_SYSTEM_V1_' + window.location.hostname;
            const ALLOWED_DOMAINS = ['localhost', '127.0.0.1', 'parliament.gov', 'gov.eg'];
            const ENCRYPTION_KEY = btoa(SYSTEM_KEY).substring(0, 32);
            
            // نظام مراقبة السلوك
            class SecurityMonitor {
                constructor() {
                    this.detectedThreats = [];
                    this.securityLevel = 0;
                    this.init();
                }
                
                init() {
                    this.checkEnvironment();
                    this.setupProtection();
                    this.startMonitoring();
                }
                
                checkEnvironment() {
                    // 1. التحقق من النطاق
                    const currentDomain = window.location.hostname;
                    const isValidDomain = ALLOWED_DOMAINS.some(domain => 
                        currentDomain === domain || currentDomain.endsWith('.' + domain)
                    );
                    
                    if (!isValidDomain) {
                        this.logThreat('محاولة وصول من نطاق غير مصرح: ' + currentDomain);
                        this.blockAccess();
                        return false;
                    }
                    
                    // 2. التحقق من أن الصفحة ليست في iframe
                    if (window.self !== window.top) {
                        this.logThreat('محاولة تضمين النظام في iframe');
                        this.blockAccess();
                        return false;
                    }
                    
                    // 3. التحقق من أدوات المطورين
                    const devToolsOpen = window.outerWidth - window.innerWidth > 100 || 
                                        window.outerHeight - window.innerHeight > 100;
                    
                    if (devToolsOpen) {
                        this.logThreat('تم اكتشاف أدوات المطورين');
                        this.showWarning('يُمنع استخدام أدوات المطورين في هذا النظام');
                    }
                    
                    return true;
                }
                
                setupProtection() {
                    // منع النسخ
                    document.addEventListener('copy', (e) => {
                        if (window.getSelection().toString().length > 100) {
                            e.preventDefault();
                            this.showWarning('يُمنع نسخ المحتوى');
                        }
                    });
                    
                    // منع النقر الأيمن
                    document.addEventListener('contextmenu', (e) => {
                        e.preventDefault();
                        this.showWarning('ميزة النقر الأيمن معطلة');
                    });
                    
                    // منع فحص المصدر
                    document.addEventListener('keydown', (e) => {
                        // F12, Ctrl+U, Ctrl+Shift+I, Ctrl+Shift+J
                        if (e.keyCode === 123 || 
                            (e.ctrlKey && e.keyCode === 85) ||
                            (e.ctrlKey && e.shiftKey && e.keyCode === 73) ||
                            (e.ctrlKey && e.shiftKey && e.keyCode === 74)) {
                            e.preventDefault();
                            this.showWarning('ميزة فحص المصدر معطلة');
                            return false;
                        }
                    });
                    
                    // منع سحب الصور والنصوص
                    document.addEventListener('dragstart', (e) => {
                        if (e.target.tagName === 'IMG' || e.target.tagName === 'A') {
                            e.preventDefault();
                        }
                    });
                    
                    // تشفير localStorage
                    this.encryptLocalStorage();
                }
                
                encryptLocalStorage() {
                    const originalSetItem = Storage.prototype.setItem;
                    Storage.prototype.setItem = function(key, value) {
                        const encryptedValue = btoa(encodeURIComponent(value + ENCRYPTION_KEY));
                        originalSetItem.call(this, key, encryptedValue);
                    };
                    
                    const originalGetItem = Storage.prototype.getItem;
                    Storage.prototype.getItem = function(key) {
                        const encryptedValue = originalGetItem.call(this, key);
                        if (encryptedValue) {
                            try {
                                const decrypted = decodeURIComponent(atob(encryptedValue));
                                return decrypted.replace(ENCRYPTION_KEY, '');
                            } catch (e) {
                                return null;
                            }
                        }
                        return null;
                    };
                }
                
                startMonitoring() {
                    // مراقبة تغييرات DOM
                    const observer = new MutationObserver((mutations) => {
                        mutations.forEach((mutation) => {
                            if (mutation.type === 'childList') {
                                this.checkForMaliciousNodes(mutation.addedNodes);
                            }
                        });
                    });
                    
                    observer.observe(document.documentElement, {
                        childList: true,
                        subtree: true
                    });
                    
                    // مراقبة الطلبات
                    const originalFetch = window.fetch;
                    window.fetch = function(...args) {
                        const url = args[0];
                        if (typeof url === 'string' && !url.startsWith(window.location.origin)) {
                            console.warn('محاولة اتصال خارجي:', url);
                        }
                        return originalFetch.apply(this, args);
                    };
                }
                
                checkForMaliciousNodes(nodes) {
                    nodes.forEach(node => {
                        if (node.nodeType === 1) { // عنصر
                            const scripts = node.querySelectorAll ? node.querySelectorAll('script') : [];
                            scripts.forEach(script => {
                                if (script.src && !script.src.includes(window.location.origin)) {
                                    this.logThreat('تم اكتشاف سكريبت خارجي');
                                    script.remove();
                                }
                            });
                        }
                    });
                }
                
                logThreat(message) {
                    this.detectedThreats.push({
                        message: message,
                        timestamp: new Date().toISOString(),
                        url: window.location.href,
                        userAgent: navigator.userAgent
                    });
                    
                    console.warn('⚠️ تهديد أمني:', message);
                    this.securityLevel++;
                    
                    if (this.securityLevel > 3) {
                        this.blockAccess();
                    }
                }
                
                showWarning(message) {
                    const warning = document.createElement('div');
                    warning.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #ff4444;
                        color: white;
                        padding: 10px 20px;
                        border-radius: 5px;
                        z-index: 999999;
                        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
                        animation: slideIn 0.3s ease-out;
                    `;
                    
                    warning.innerHTML = `
                        <i class="fas fa-exclamation-circle"></i>
                        <span style="margin-right: 10px;">${message}</span>
                        <button onclick="this.parentElement.remove()" 
                                style="background:none;border:none;color:white;cursor:pointer">
                            ✕
                        </button>
                    `;
                    
                    document.body.appendChild(warning);
                    setTimeout(() => warning.remove(), 3000);
                }
                
                blockAccess() {
                    document.getElementById('protection-overlay').style.display = 'flex';
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('app-container').style.display = 'none';
                    
                    // محو البيانات الحساسة
                    localStorage.clear();
                    sessionStorage.clear();
                }
            }
            
            // ===================== نظام التحميل الآمن =====================
            class SecureAppLoader {
                constructor() {
                    this.appData = null;
                    this.shadowRoot = null;
                    this.security = new SecurityMonitor();
                }
                
                async initialize() {
                    try {
                        // 1. التحقق من البيئة الآمنة
                        if (!this.security.checkEnvironment()) {
                            return;
                        }
                        
                        // 2. جلب بيانات التطبيق المشفرة
                        await this.loadEncryptedApp();
                        
                        // 3. إنشاء Shadow DOM
                        this.createShadowDOM();
                        
                        // 4. تحميل التطبيق
                        this.loadApplication();
                        
                        // 5. إخفاء شاشة التحميل
                        setTimeout(() => {
                            document.getElementById('app-loader').style.display = 'none';
                        }, 1000);
                        
                    } catch (error) {
                        console.error('خطأ في تحميل النظام:', error);
                        this.showError('فشل تحميل النظام', error.message);
                    }
                }
                
                async loadEncryptedApp() {
                    // في بيئة حقيقية، سيتم جلب هذا من الخادم
                    this.appData = {
                        styles: this.getEncryptedStyles(),
                        templates: this.getEncryptedTemplates(),
                        logic: this.getEncryptedLogic()
                    };
                }
                
                createShadowDOM() {
                    const appContainer = document.getElementById('app-container');
                    appContainer.style.display = 'block';
                    
                    // إنشاء Shadow DOM مغلق (لا يمكن الوصول إليه من الخارج)
                    this.shadowRoot = appContainer.attachShadow({ 
                        mode: 'closed',
                        delegatesFocus: true
                    });
                    
                    // إضافة علامة مائية مخفية
                    this.addWatermark();
                }
                
                addWatermark() {
                    const watermark = document.createElement('div');
                    watermark.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                        z-index: 999999;
                        background: repeating-linear-gradient(
                            45deg,
                            transparent,
                            transparent 100px,
                            rgba(255,0,0,0.02) 100px,
                            rgba(255,0,0,0.02) 200px
                        );
                        opacity: 0.1;
                        display: none;
                    `;
                    this.shadowRoot.appendChild(watermark);
                }
                
                loadApplication() {
                    // إنشاء التطبيق داخل Shadow DOM
                    const appContent = this.generateAppContent();
                    this.shadowRoot.innerHTML = appContent;
                    
                    // حقن التنسيقات
                    this.injectStyles();
                    
                    // تهيئة التطبيق
                    this.initializeAppLogic();
                }
                
                generateAppContent() {
                    return `
                        <div id="protected-app">
                            <!-- المحتوى سيتم توليده ديناميكياً -->
                            <div class="protected-loading">
                                <div class="spinner"></div>
                                <p>جاري تهيئة النظام...</p>
                            </div>
                        </div>
                    `;
                }
                
                injectStyles() {
                    const style = document.createElement('style');
                    style.textContent = this.decryptContent(this.appData.styles);
                    this.shadowRoot.appendChild(style);
                }
                
                initializeAppLogic() {
                    // فك تشفير وتنفيذ المنطق
                    const appLogic = this.decryptContent(this.appData.logic);
                    
                    // إنشاء سياق آمن لتنفيذ الكود
                    const secureEval = new Function('shadowRoot', 'appData', `
                        try {
                            ${appLogic}
                        } catch(e) {
                            console.error('خطأ في تنفيذ التطبيق:', e);
                        }
                    `);
                    
                    // تنفيذ التطبيق داخل Shadow DOM
                    secureEval.call(this.shadowRoot, this.shadowRoot, this.appData);
                }
                
                decryptContent(encrypted) {
                    // فك تشفير بسيط (في البيئة الحقيقية يستخدم خوارزمية أقوى)
                    let decrypted = '';
                    for (let i = 0; i < encrypted.length; i++) {
                        decrypted += String.fromCharCode(
                            encrypted.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length)
                        );
                    }
                    return decrypted;
                }
                
                getEncryptedStyles() {
                    // التنسيقات المشفرة
                    return this.encryptContent(`
                        /* التنسيقات الرئيسية */
                        #protected-app {
                            width: 100%;
                            min-height: 100vh;
                            background: #f8fafc;
                        }
                        
                        .protected-loading {
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            height: 100vh;
                        }
                        
                        .protected-loading .spinner {
                            width: 50px;
                            height: 50px;
                            border: 3px solid #e5e7eb;
                            border-radius: 50%;
                            border-top-color: #3b82f6;
                            animation: spin 1s linear infinite;
                            margin-bottom: 20px;
                        }
                        
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                        
                        /* تنسيقات النظام */
                        :root {
                            --primary-color: #1e3a8a;
                            --secondary-color: #3b82f6;
                            --success-color: #10b981;
                            --warning-color: #f59e0b;
                            --danger-color: #ef4444;
                        }
                        
                        .auth-page {
                            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
                            height: 100vh;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            padding: 20px;
                        }
                        
                        .auth-card {
                            background: white;
                            border-radius: 20px;
                            box-shadow: 0 15px 35px rgba(0,0,0,0.2);
                            overflow: hidden;
                            width: 100%;
                            max-width: 450px;
                        }
                        
                        .auth-header {
                            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                            color: white;
                            padding: 30px;
                            text-align: center;
                        }
                        
                        .auth-body {
                            padding: 30px;
                        }
                        
                        .form-control {
                            border: 2px solid #e5e7eb;
                            border-radius: 10px;
                            padding: 12px 15px;
                            transition: all 0.3s;
                            width: 100%;
                        }
                        
                        .btn-auth {
                            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
                            border: none;
                            color: white;
                            padding: 14px;
                            border-radius: 10px;
                            font-weight: 600;
                            font-size: 16px;
                            width: 100%;
                            cursor: pointer;
                        }
                        
                        /* ... المزيد من التنسيقات ... */
                    `);
                }
                
                getEncryptedTemplates() {
                    // قوالب HTML المشفرة
                    return this.encryptContent(JSON.stringify({
                        login: `
                            <div class="auth-page">
                                <div class="auth-card">
                                    <div class="auth-header">
                                        <h1>تسجيل الدخول</h1>
                                        <p>نظام متابعة طلبات المواطنين</p>
                                    </div>
                                    <div class="auth-body">
                                        <form id="loginForm">
                                            <input type="text" class="form-control" placeholder="اسم المستخدم" required>
                                            <input type="password" class="form-control" placeholder="كلمة المرور" required>
                                            <button type="submit" class="btn-auth">تسجيل الدخول</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        `,
                        dashboard: `
                            <div class="dashboard">
                                <h1>لوحة التحكم</h1>
                                <!-- ... -->
                            </div>
                        `
                    }));
                }
                
                getEncryptedLogic() {
                    // منطق التطبيق المشفر
                    return this.encryptContent(`
                        // نظام المصادقة
                        const authSystem = {
                            users: [
                                { username: 'admin', password: 'admin123', role: 'admin' },
                                { username: 'user', password: 'user123', role: 'user' }
                            ],
                            
                            login(username, password) {
                                const user = this.users.find(u => 
                                    u.username === username && u.password === password
                                );
                                
                                if (user) {
                                    localStorage.setItem('user', JSON.stringify(user));
                                    this.showDashboard();
                                    return true;
                                }
                                return false;
                            },
                            
                            showDashboard() {
                                const app = document.getElementById('protected-app');
                                app.innerHTML = \`
                                    <div class="dashboard">
                                        <nav class="sidebar">
                                            <h3>نظام الطلبات</h3>
                                            <ul>
                                                <li><a href="#" onclick="app.showPage('requests')">الطلبات</a></li>
                                                <li><a href="#" onclick="app.showPage('reports')">التقارير</a></li>
                                                <li><a href="#" onclick="app.logout()">تسجيل الخروج</a></li>
                                            </ul>
                                        </nav>
                                        <main class="content">
                                            <div id="page-content"></div>
                                        </main>
                                    </div>
                                \`;
                            },
                            
                            logout() {
                                localStorage.removeItem('user');
                                this.showLogin();
                            },
                            
                            showLogin() {
                                const app = document.getElementById('protected-app');
                                app.innerHTML = \`
                                    <div class="auth-page">
                                        <div class="auth-card">
                                            <div class="auth-header">
                                                <h1>تسجيل الدخول</h1>
                                                <p>نظام متابعة طلبات المواطنين</p>
                                            </div>
                                            <div class="auth-body">
                                                <form id="loginForm">
                                                    <input type="text" class="form-control" placeholder="اسم المستخدم" required>
                                                    <input type="password" class="form-control" placeholder="كلمة المرور" required>
                                                    <button type="submit" class="btn-auth">تسجيل الدخول</button>
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                \`;
                                
                                document.getElementById('loginForm').addEventListener('submit', (e) => {
                                    e.preventDefault();
                                    const username = e.target[0].value;
                                    const password = e.target[1].value;
                                    
                                    if (this.login(username, password)) {
                                        alert('تم تسجيل الدخول بنجاح');
                                    } else {
                                        alert('اسم المستخدم أو كلمة المرور غير صحيحة');
                                    }
                                });
                            }
                        };
                        
                        // بدء التطبيق
                        window.app = authSystem;
                        
                        // التحقق من حالة تسجيل الدخول
                        const savedUser = localStorage.getItem('user');
                        if (savedUser) {
                            authSystem.showDashboard();
                        } else {
                            authSystem.showLogin();
                        }
                    `);
                }
                
                encryptContent(content) {
                    // تشفير المحتوى
                    let encrypted = '';
                    for (let i = 0; i < content.length; i++) {
                        encrypted += String.fromCharCode(
                            content.charCodeAt(i) ^ ENCRYPTION_KEY.charCodeAt(i % ENCRYPTION_KEY.length)
                        );
                    }
                    return encrypted;
                }
                
                showError(title, message) {
                    document.getElementById('app-loader').style.display = 'none';
                    document.getElementById('error-container').style.display = 'block';
                    document.getElementById('error-title').textContent = title;
                    document.getElementById('error-message').textContent = message;
                    
                    document.getElementById('retry-btn').onclick = () => {
                        location.reload();
                    };
                }
            }
            
            // ===================== بدء النظام =====================
            document.addEventListener('DOMContentLoaded', () => {
                // إضافة تأخير لمحاكاة التحميل من الخادم
                setTimeout(() => {
                    const loader = new SecureAppLoader();
                    loader.initialize();
                }, 1500);
            });
            
            // منع الإغلاق أثناء التحميل
            window.addEventListener('beforeunload', (e) => {
                if (document.getElementById('app-loader').style.display !== 'none') {
                    e.preventDefault();
                    e.returnValue = 'جاري تحميل النظام، هل تريد المغادرة؟';
                }
            });
            
        })();
    </script>
</body>
</html>